<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curator Landing Page â€” Noctua Forest</title>
    <meta name="description" content="Customize your curator landing page with Curator Plus">
    <link rel="stylesheet" href="assets/tailwind.css">
    <link rel="stylesheet" href="assets/base-styles.css">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;700&family=Noto+Serif:wght@400;600;700&family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-[#fbebcc]">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <header class="flex justify-between items-center mb-8">
            <a href="dashboard.html" class="flex items-center space-x-3">
                <svg class="w-6 h-6 text-forest-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.42-1.41L7.83 13H20v-2z"/>
                </svg>
                <span class="text-lg font-medium text-forest-accent">Back to Dashboard</span>
            </a>
            <div class="flex items-center space-x-3">
                <img src="images/logo.png" alt="Noctua Forest Logo" width="32" height="32" decoding="async" class="w-8 h-8">
                <span class="text-xl font-bold" style="font-family: 'Poppins', sans-serif; color: #4A5450;">Noctua Forest</span>
            </div>
        </header>

        <main class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="bg-forest-card rounded-xl p-8 mb-8">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h1 class="text-3xl font-bold text-white mb-2" style="font-family: 'Poppins', sans-serif;">Curator Landing Page</h1>
                        <p class="text-white/80">Customize your curator landing page with Curator Plus</p>
                    </div>
                    <div class="bg-forest-accent px-4 py-2 rounded-full text-sm font-medium">
                        Curator Plus
                    </div>
                </div>
                
                <!-- Preview/Edit Toggle -->
                <div class="flex gap-3 mb-6">
                    <button id="editMode" class="px-4 py-2 bg-forest-accent text-white rounded-lg font-medium">Edit</button>
                    <button id="previewMode" class="px-4 py-2 bg-white/10 text-white rounded-lg font-medium">Preview</button>
                </div>
            </div>

            <div class="grid lg:grid-cols-2 gap-8">
                <!-- Editor Panel -->
                <div id="editorPanel" class="space-y-6">
                    <!-- Basic Info -->
                    <div class="bg-white rounded-xl p-6">
                        <h2 class="text-xl font-semibold mb-4 text-[#4A5450]">Basic Information</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="curatorName" class="block text-sm font-medium text-[#4A5450] mb-2">Curator Name</label>
                                <input type="text" id="curatorName" placeholder="Your curator name" 
                                       class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-forest-accent">
                            </div>
                            <div>
                                <label for="curatorBio" class="block text-sm font-medium text-[#4A5450] mb-2">Bio</label>
                                <textarea id="curatorBio" rows="3" placeholder="Tell readers about yourself and your reading preferences"
                                          class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-forest-accent"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Hero Section -->
                    <div class="bg-white rounded-xl p-6">
                        <h2 class="text-xl font-semibold mb-4 text-[#4A5450]">Hero Section</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="heroTitle" class="block text-sm font-medium text-[#4A5450] mb-2">Hero Title</label>
                                <input type="text" id="heroTitle" placeholder="Welcome to my curated collection"
                                       class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-forest-accent">
                            </div>
                            <div>
                                <label for="heroSubtitle" class="block text-sm font-medium text-[#4A5450] mb-2">Hero Subtitle</label>
                                <textarea id="heroSubtitle" rows="2" placeholder="Discover books I love and recommend"
                                          class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-forest-accent"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Featured Lists -->
                    <div class="bg-white rounded-xl p-6">
                        <h2 class="text-xl font-semibold mb-4 text-[#4A5450]">Featured Lists</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="featuredList1" class="block text-sm font-medium text-[#4A5450] mb-2">Featured List 1</label>
                                <select id="featuredList1" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-forest-accent">
                                    <option value="">Select a list...</option>
                                </select>
                            </div>
                            <div>
                                <label for="featuredList2" class="block text-sm font-medium text-[#4A5450] mb-2">Featured List 2</label>
                                <select id="featuredList2" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-forest-accent">
                                    <option value="">Select a list...</option>
                                </select>
                            </div>
                            <div>
                                <label for="featuredList3" class="block text-sm font-medium text-[#4A5450] mb-2">Featured List 3</label>
                                <select id="featuredList3" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-forest-accent">
                                    <option value="">Select a list...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Social Links -->
                    <div class="bg-white rounded-xl p-6">
                        <h2 class="text-xl font-semibold mb-4 text-[#4A5450]">Social Links</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="website" class="block text-sm font-medium text-[#4A5450] mb-2">Website</label>
                                <input type="url" id="website" placeholder="https://yourwebsite.com"
                                       class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-forest-accent">
                            </div>
                            <div>
                                <label for="twitter" class="block text-sm font-medium text-[#4A5450] mb-2">Twitter/X</label>
                                <input type="url" id="twitter" placeholder="https://twitter.com/yourhandle"
                                       class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-forest-accent">
                            </div>
                            <div>
                                <label for="instagram" class="block text-sm font-medium text-[#4A5450] mb-2">Instagram</label>
                                <input type="url" id="instagram" placeholder="https://instagram.com/yourhandle"
                                       class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-forest-accent">
                            </div>
                        </div>
                    </div>

                    <!-- Color Theme -->
                    <div class="bg-white rounded-xl p-6">
                        <h2 class="text-xl font-semibold mb-4 text-[#4A5450]">Color Theme</h2>
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label for="primaryColor" class="block text-sm font-medium text-[#4A5450] mb-2">Primary Color</label>
                                <input type="color" id="primaryColor" value="#F58220" 
                                       class="w-full h-12 rounded-lg border border-gray-300">
                            </div>
                            <div>
                                <label for="secondaryColor" class="block text-sm font-medium text-[#4A5450] mb-2">Secondary Color</label>
                                <input type="color" id="secondaryColor" value="#4A5450" 
                                       class="w-full h-12 rounded-lg border border-gray-300">
                            </div>
                            <div>
                                <label for="accentColor" class="block text-sm font-medium text-[#4A5450] mb-2">Accent Color</label>
                                <input type="color" id="accentColor" value="#3A4440" 
                                       class="w-full h-12 rounded-lg border border-gray-300">
                            </div>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div class="bg-white rounded-xl p-6">
                        <button id="saveLandingPage" class="w-full px-6 py-3 bg-forest-accent hover:bg-[#E0751C] text-white font-semibold rounded-lg transition duration-300 mb-4">
                            Save Landing Page
                        </button>
                        <a id="viewPublicPage" href="#" target="_blank" class="w-full block text-center px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold rounded-lg transition duration-300">
                            View Public Page
                        </a>
                    </div>
                </div>

                <!-- Preview Panel -->
                <div id="previewPanel" class="space-y-6">
                    <div class="bg-white rounded-xl p-6">
                        <h2 class="text-xl font-semibold mb-4 text-[#4A5450]">Live Preview</h2>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 min-h-[600px]">
                            <div id="landingPreview" class="space-y-6">
                                <!-- Preview content will be generated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js';
        import { doc, getDoc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';
        import { app, db } from './firebase-config.js';
        import { getUserLists } from './js/readingListService.js';

        const auth = getAuth(app);
        let currentUser = null;

        // Check authentication and membership
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'account.html';
                return;
            }

            currentUser = user;
            
            // Check if user has Curator Plus
            try {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                const userData = userDoc.exists() ? userDoc.data() : {};
                
                if (!userData.membership || userData.membership !== 'active') {
                    alert('Curator Plus membership required to access this feature.');
                    window.location.href = 'membership.html';
                    return;
                }
            } catch (error) {
                console.error('Error checking membership:', error);
                alert('Error verifying membership. Please try again.');
                return;
            }

            // Load user's lists for featured lists dropdown
            await loadUserLists();
            
            // Load existing landing page data
            await loadLandingPageData();
            
            // Set up event listeners
            setupEventListeners();
            
            // Set public page link
            document.getElementById('viewPublicPage').href = `curator.html?id=${currentUser.uid}`;
        });

        async function loadUserLists() {
            try {
                const lists = await getUserLists(currentUser.uid);
                const selectElements = ['featuredList1', 'featuredList2', 'featuredList3'];
                
                selectElements.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    select.innerHTML = '<option value="">Select a list...</option>';
                    
                    lists.forEach(list => {
                        const option = document.createElement('option');
                        option.value = list.id;
                        option.textContent = list.name;
                        select.appendChild(option);
                    });
                });
            } catch (error) {
                console.error('Error loading user lists:', error);
            }
        }

        async function loadLandingPageData() {
            try {
                const landingDoc = await getDoc(doc(db, 'curatorLandingPages', currentUser.uid));
                if (landingDoc.exists()) {
                    const data = landingDoc.data();
                    
                    // Populate form fields
                    document.getElementById('curatorName').value = data.curatorName || '';
                    document.getElementById('curatorBio').value = data.curatorBio || '';
                    document.getElementById('heroTitle').value = data.heroTitle || '';
                    document.getElementById('heroSubtitle').value = data.heroSubtitle || '';
                    document.getElementById('featuredList1').value = data.featuredLists?.[0] || '';
                    document.getElementById('featuredList2').value = data.featuredLists?.[1] || '';
                    document.getElementById('featuredList3').value = data.featuredLists?.[2] || '';
                    document.getElementById('website').value = data.socialLinks?.website || '';
                    document.getElementById('twitter').value = data.socialLinks?.twitter || '';
                    document.getElementById('instagram').value = data.socialLinks?.instagram || '';
                    document.getElementById('primaryColor').value = data.colors?.primary || '#F58220';
                    document.getElementById('secondaryColor').value = data.colors?.secondary || '#4A5450';
                    document.getElementById('accentColor').value = data.colors?.accent || '#3A4440';
                }
                
                // Generate initial preview
                generatePreview();
            } catch (error) {
                console.error('Error loading landing page data:', error);
            }
        }

        function setupEventListeners() {
            // Mode toggle
            document.getElementById('editMode').addEventListener('click', () => {
                document.getElementById('editorPanel').classList.remove('hidden');
                document.getElementById('previewPanel').classList.add('hidden');
            });
            
            document.getElementById('previewMode').addEventListener('click', () => {
                document.getElementById('editorPanel').classList.add('hidden');
                document.getElementById('previewPanel').classList.remove('hidden');
            });

            // Save button
            document.getElementById('saveLandingPage').addEventListener('click', saveLandingPage);

            // Real-time preview updates
            const inputs = document.querySelectorAll('#editorPanel input, #editorPanel textarea, #editorPanel select');
            inputs.forEach(input => {
                input.addEventListener('input', generatePreview);
                input.addEventListener('change', generatePreview);
            });
        }

        function generatePreview() {
            const preview = document.getElementById('landingPreview');
            const curatorName = document.getElementById('curatorName').value || 'Your Name';
            const curatorBio = document.getElementById('curatorBio').value || 'Passionate reader and curator';
            const heroTitle = document.getElementById('heroTitle').value || 'Welcome to my curated collection';
            const heroSubtitle = document.getElementById('heroSubtitle').value || 'Discover books I love and recommend';
            const primaryColor = document.getElementById('primaryColor').value;
            const secondaryColor = document.getElementById('secondaryColor').value;
            const accentColor = document.getElementById('accentColor').value;

            preview.innerHTML = `
                <div class="bg-forest-card rounded-xl p-8 text-white" style="background-color: ${accentColor};">
                    <div class="text-center mb-8">
                        <h1 class="text-4xl font-bold mb-4" style="color: ${primaryColor};">${heroTitle}</h1>
                        <p class="text-xl text-white/80">${heroSubtitle}</p>
                    </div>
                    
                    <div class="bg-white/10 rounded-xl p-6 mb-6">
                        <h2 class="text-2xl font-semibold mb-3" style="color: ${primaryColor};">About ${curatorName}</h2>
                        <p class="text-white/90">${curatorBio}</p>
                    </div>
                    
                    <div class="grid md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-white/10 rounded-lg p-4 text-center">
                            <h3 class="font-semibold mb-2">Featured List 1</h3>
                            <p class="text-sm text-white/70">Coming soon...</p>
                        </div>
                        <div class="bg-white/10 rounded-lg p-4 text-center">
                            <h3 class="font-semibold mb-2">Featured List 2</h3>
                            <p class="text-sm text-white/70">Coming soon...</p>
                        </div>
                        <div class="bg-white/10 rounded-lg p-4 text-center">
                            <h3 class="font-semibold mb-2">Featured List 3</h3>
                            <p class="text-sm text-white/70">Coming soon...</p>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <a href="forest.html" class="inline-block px-6 py-3 rounded-lg font-semibold transition duration-300" 
                           style="background-color: ${primaryColor}; color: white;">
                            Explore The Forest
                        </a>
                    </div>
                </div>
            `;
        }

        async function saveLandingPage() {
            try {
                const landingData = {
                    curatorName: document.getElementById('curatorName').value,
                    curatorBio: document.getElementById('curatorBio').value,
                    heroTitle: document.getElementById('heroTitle').value,
                    heroSubtitle: document.getElementById('heroSubtitle').value,
                    featuredLists: [
                        document.getElementById('featuredList1').value,
                        document.getElementById('featuredList2').value,
                        document.getElementById('featuredList3').value
                    ].filter(Boolean),
                    socialLinks: {
                        website: document.getElementById('website').value,
                        twitter: document.getElementById('twitter').value,
                        instagram: document.getElementById('instagram').value
                    },
                    colors: {
                        primary: document.getElementById('primaryColor').value,
                        secondary: document.getElementById('secondaryColor').value,
                        accent: document.getElementById('accentColor').value
                    },
                    updatedAt: serverTimestamp()
                };

                await setDoc(doc(db, 'curatorLandingPages', currentUser.uid), landingData, { merge: true });
                
                alert('Landing page saved successfully!');
            } catch (error) {
                console.error('Error saving landing page:', error);
                alert('Error saving landing page. Please try again.');
            }
        }
    </script>
</body>
</html>
