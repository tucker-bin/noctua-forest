<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Recommendations — Noctua Forest</title>
    <meta name="description" content="Curated book recommendations from Noctua Forest">
    <meta property="og:title" content="Book Recommendations — Noctua Forest">
    <meta property="og:description" content="Explore curated book recommendations from Noctua Forest">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary">
    <link rel="canonical" href="https://noctuaforest.com/club.html">
    <link rel="stylesheet" href="assets/tailwind.css">
    <link rel="stylesheet" href="assets/base-styles.css">
    <link rel="stylesheet" href="assets/nav.css">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;700&family=Noto+Serif:wght@400;600;700&family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Global Footer with Google Translate -->
    <script src="assets/footer.js"></script>
    
    <!-- Dynamic styles will be injected here -->
    <style id="dynamic-styles"></style>
</head>
<body class="bg-[#fbebcc] text-[#2D3748]">
    <!-- Navigation -->
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <header class="flex justify-between items-center mb-8">
            <a href="welcome.html" class="flex items-center space-x-3">
                <img src="images/logo.png" alt="Noctua Forest Logo" width="40" height="40" decoding="async" class="w-10 h-10">
                <span class="text-2xl font-bold" style="font-family: 'Poppins', sans-serif; color: #4A5450;">Noctua Forest</span>
            </a>
            <nav id="nav" class="hidden md:flex items-center space-x-8 text-lg ml-auto" style="font-family: 'Noto Sans', sans-serif;">
                <a href="forest.html" class="nav-link hover:text-forest-accent transition-colors duration-300 font-medium block md:inline-block py-3 md:py-0 px-4 md:px-0 text-left md:text-center" style="color:#3A4440">The Forest</a>
                <a href="reviews.html" class="nav-link hover:text-forest-accent transition-colors duration-300 font-medium block md:inline-block py-3 md:py-0 px-4 md:px-0 text-left md:text-center" style="color:#3A4440">Write a Review</a>
                <a href="help.html" class="nav-link hover:text-forest-accent transition-colors duration-300 font-medium block md:inline-block py-3 md:py-0 px-4 md:px-0 text-left md:text-center" style="color:#3A4440">Help</a>
                <a href="about.html" class="nav-link hover:text-forest-accent transition-colors duration-300 font-medium block md:inline-block py-3 md:py-0 px-4 md:px-0 text-left md:text-center" style="color:#3A4440">About</a>
            </nav>
            <div class="flex items-center gap-6">
                <button class="md:hidden" onclick="toggleMobileMenu()" aria-label="Toggle menu">
                    <svg class="w-6 h-6" fill="none" stroke="#4A5450" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
                <a href="account.html" class="hover:text-forest-accent transition-colors duration-300 nav-link" aria-label="Account">
                    <svg class="w-6 h-6" fill="none" stroke="#4A5450" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                </a>
            </div>
        </header>
    </div>
    
    <!-- Mobile Navigation Overlay -->
    <div id="navOverlay" class="nav-overlay"></div>
    
    <!-- Curator Header -->
    <div id="curator-header" class="w-full h-64 bg-cover bg-center relative">
        <div class="absolute inset-0 bg-gradient-to-b from-black/40 to-black/70"></div>
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 h-full flex flex-col justify-end">
            <div class="text-white mb-8 relative z-10">
                <h1 id="club-name" class="text-3xl md:text-5xl font-bold mb-2">Book Club Name</h1>
                <p id="club-description" class="text-xl text-white/80">Loading curator page...</p>
            </div>
        </div>
    </div>
    
    <!-- Curator Info -->
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="bg-white rounded-xl shadow-lg p-6 -mt-8 relative z-20 max-w-4xl mx-auto">
            <div id="welcome-message" class="prose max-w-none">
                <p>Welcome to my book club! Here you'll find my favorite reading recommendations...</p>
            </div>
        </div>
    </div>
    
    <!-- Social Links -->
    <div id="social-links" class="flex justify-center space-x-4 py-4">
        <!-- Social links will be populated here -->
    </div>
    
    <!-- Reading Lists -->
    <div id="reading-lists" class="space-y-12 py-8">
        <div class="text-center py-12">
            <div class="inline-block rounded-full bg-gray-200 p-3">
                <svg class="w-8 h-8 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                </svg>
            </div>
            <h2 class="text-2xl font-bold mt-4">Loading Reading Lists...</h2>
            <p class="text-gray-500 mt-2">Please wait while we fetch the curator's recommendations</p>
        </div>
    </div>
    
    <!-- List Template (hidden) -->
    <template id="list-template">
        <div class="list-container container mx-auto px-4 sm:px-6 lg:px-8 mb-16">
            <h2 class="text-2xl md:text-3xl font-bold mb-2 list-title">List Title</h2>
            <p class="text-lg text-forest-text-muted mb-6 list-description">List description goes here...</p>
            
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 list-books">
                <!-- Books will be populated here -->
            </div>
        </div>
    </template>
    
    <!-- Book Template (hidden) -->
    <template id="book-template">
        <a href="#" class="book-link group">
            <div class="aspect-[3/4] rounded-lg overflow-hidden shadow-md transition-all duration-300 group-hover:shadow-xl book-cover-container">
                <img class="w-full h-full object-cover book-cover" src="" alt="Book cover" crossorigin="anonymous">
            </div>
            <div class="mt-3">
                <h3 class="font-medium text-forest-text line-clamp-2 group-hover:text-forest-accent transition-colors duration-300 book-title">Book Title</h3>
                <p class="text-sm text-forest-text-muted book-author">Author Name</p>
            </div>
        </a>
    </template>
    
    <!-- Footer with Curator Plus Promotion -->
    <div class="bg-forest-card py-12 text-white">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <h2 class="text-2xl md:text-3xl font-bold mb-4">Create Your Own Book Club</h2>
            <p class="text-white/80 max-w-2xl mx-auto mb-6">
                Want to create your own personalized book club page? Become a Curator Plus member and start sharing your recommendations.
            </p>
            <a href="membership.html" class="inline-block bg-forest-accent hover:bg-forest-accent-hover text-white font-semibold py-3 px-8 rounded-full transition-all duration-300">
                Become a Curator
            </a>
        </div>
    </div>
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0ZWN1Z3DYQ" onerror="console.warn('Google Analytics failed to load')"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-0ZWN1Z3DYQ');
    </script>
    
    <!-- Firebase Configuration & JS Logic -->
    <script type="module">
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js';
        import { app, db } from './firebase-config.js';
        import { collection, doc, getDoc, getDocs, query, where, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';
        import * as bookClubService from './js/bookClubService.js';
        
        const auth = getAuth(app);
        let currentUser = null;
        let curatorPage = null;
        let visitorId = null;
        
        // Generate a random visitor ID for tracking
        function generateVisitorId() {
            return 'visitor_' + Math.random().toString(36).substring(2, 15);
        }
        
        // Get visitor ID from localStorage or create a new one
        function getVisitorId() {
            let id = localStorage.getItem('nf_visitor_id');
            if (!id) {
                id = generateVisitorId();
                localStorage.setItem('nf_visitor_id', id);
            }
            return id;
        }
        
        // Check authentication status
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
        });
        
        // Get club ID from URL
        function getClubIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }
        
        // Load curator page data
        async function loadCuratorPage() {
            const clubId = getClubIdFromUrl();
            if (!clubId) {
                showError('No club ID provided');
                return;
            }
            
            try {
                // Get visitor ID for tracking
                visitorId = getVisitorId();
                
                // Get club data
                curatorPage = await bookClubService.getCuratorPage(clubId);
                if (!curatorPage) {
                    showError('Book club not found');
                    return;
                }
                
                // Apply theme and update page
                applyTheme(curatorPage);
                updateCuratorInfo(curatorPage);
                
                // Load reading lists
                await loadReadingLists(clubId);
                
                // Track page view (could be implemented later)
                // trackPageView(clubId, visitorId);
                
            } catch (error) {
                console.error('Error loading curator page:', error);
                showError('Error loading curator page');
            }
        }
        
        // Apply theme to page
        function applyTheme(club) {
            const primaryColor = club.primaryColor || '#F58220';
            const secondaryColor = club.secondaryColor || '#3A4440';
            
            // Update dynamic styles
            const dynamicStyles = document.getElementById('dynamic-styles');
            dynamicStyles.textContent = `
                :root {
                    --primary-color: ${primaryColor};
                    --secondary-color: ${secondaryColor};
                }
                
                .bg-primary { background-color: var(--primary-color); }
                .bg-secondary { background-color: var(--secondary-color); }
                .text-primary { color: var(--primary-color); }
                .text-secondary { color: var(--secondary-color); }
                .border-primary { border-color: var(--primary-color); }
                
                .book-link:hover .book-title {
                    color: var(--primary-color);
                }
                
                .list-title {
                    color: var(--secondary-color);
                }
            `;
            
            // Update header background if available
            if (club.headerImage) {
                document.getElementById('curator-header').style.backgroundImage = `url(${club.headerImage})`;
            } else {
                document.getElementById('curator-header').style.backgroundColor = secondaryColor;
            }
        }
        
        // Update curator information
        function updateCuratorInfo(club) {
            document.title = `${club.name} — Noctua Forest`;
            document.getElementById('club-name').textContent = club.name;
            document.getElementById('club-description').textContent = club.description || '';
            
            const welcomeMessage = document.getElementById('welcome-message');
            if (club.welcomeMessage) {
                welcomeMessage.innerHTML = `<p>${club.welcomeMessage}</p>`;
            } else {
                welcomeMessage.innerHTML = `<p>Welcome to my curated book recommendations!</p>`;
            }
            
            // Update social links if available (future enhancement)
            // updateSocialLinks(club);
        }
        
        // Load reading lists
        async function loadReadingLists(clubId) {
            try {
                const clubLists = await bookClubService.getCuratorPageLists(clubId);
                const listsContainer = document.getElementById('reading-lists');
                
                if (clubLists.length === 0) {
                    listsContainer.innerHTML = `
                        <div class="text-center py-12">
                            <div class="inline-block rounded-full bg-gray-200 p-3">
                                <svg class="w-8 h-8 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                                </svg>
                            </div>
                            <h2 class="text-2xl font-bold mt-4">No Reading Lists Yet</h2>
                            <p class="text-gray-500 mt-2">The curator hasn't added any reading lists yet</p>
                        </div>
                    `;
                    return;
                }
                
                // Clear loading state
                listsContainer.innerHTML = '';
                
                // Sort lists by order
                clubLists.sort((a, b) => a.order - b.order);
                
                // Create a list element for each list
                for (const listAssociation of clubLists) {
                    const listId = listAssociation.listId;
                    
                    // Get list details
                    const listDoc = await getDoc(doc(db, 'readingLists', listId));
                    if (!listDoc.exists()) continue;
                    
                    const list = { id: listDoc.id, ...listDoc.data() };
                    const listElement = createListElement(list, listAssociation);
                    
                    listsContainer.appendChild(listElement);
                    
                    // Load books for this list
                    await loadBooksForList(list, listElement.querySelector('.list-books'));
                }
                
            } catch (error) {
                console.error('Error loading reading lists:', error);
                document.getElementById('reading-lists').innerHTML = `
                    <div class="text-center py-12">
                        <div class="inline-block rounded-full bg-gray-200 p-3">
                            <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <h2 class="text-2xl font-bold mt-4">Error Loading Lists</h2>
                        <p class="text-gray-500 mt-2">There was a problem loading the reading lists</p>
                    </div>
                `;
            }
        }
        
        // Create a list element
        function createListElement(list, association) {
            const template = document.getElementById('list-template');
            const listElement = document.importNode(template.content, true);
            
            // Use custom title/description from association if available, otherwise use list data
            const title = association.title || list.title;
            const description = association.description || list.description;
            
            listElement.querySelector('.list-title').textContent = title;
            listElement.querySelector('.list-description').textContent = description || '';
            
            return listElement.firstElementChild;
        }
        
        // Load books for a list
        async function loadBooksForList(list, booksContainer) {
            try {
                // Get book IDs from list
                const bookIds = list.books || [];
                if (bookIds.length === 0) {
                    booksContainer.innerHTML = `
                        <div class="col-span-full text-center py-8">
                            <p class="text-gray-500">No books in this list yet</p>
                        </div>
                    `;
                    return;
                }
                
                // Clear container
                booksContainer.innerHTML = '';
                
                // Load each book
                for (const bookEntry of bookIds) {
                    const bookId = typeof bookEntry === 'object' ? bookEntry.id : bookEntry;
                    
                    // Get book details
                    const bookDoc = await getDoc(doc(db, 'books', bookId));
                    if (!bookDoc.exists()) continue;
                    
                    const book = { id: bookDoc.id, ...bookDoc.data() };
                    const bookElement = createBookElement(book, list.id);
                    
                    booksContainer.appendChild(bookElement);
                }
                
            } catch (error) {
                console.error('Error loading books for list:', error);
                booksContainer.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <p class="text-gray-500">Error loading books</p>
                    </div>
                `;
            }
        }
        
        // Create a book element
        function createBookElement(book, listId) {
            const template = document.getElementById('book-template');
            const bookElement = document.importNode(template.content, true);
            
            // Set book details
            bookElement.querySelector('.book-title').textContent = book.title;
            bookElement.querySelector('.book-author').textContent = `by ${book.author}`;
            
            // Set book link
            const bookLink = bookElement.querySelector('.book-link');
            bookLink.href = `book.html?id=${book.id}`;
            
            // Add click tracking
            bookLink.addEventListener('click', (e) => {
                const clubId = getClubIdFromUrl();
                if (clubId && listId && book.id && visitorId) {
                    bookClubService.trackBookClick(clubId, listId, book.id, visitorId)
                        .catch(err => console.error('Error tracking click:', err));
                }
            });
            
            // Set book cover
            const coverImg = bookElement.querySelector('.book-cover');
            const coverUrl = resolveCoverUrl(book);
            
            if (coverUrl) {
                coverImg.src = coverUrl;
                coverImg.alt = `Cover for ${book.title} by ${book.author}`;
                
                // Add error handler for image
                coverImg.onerror = () => {
                    replaceWithTextCover(coverImg.parentElement, book);
                };
            } else {
                replaceWithTextCover(coverImg.parentElement, book);
            }
            
            return bookElement.firstElementChild;
        }
        
        // Resolve cover URL from book data
        function resolveCoverUrl(data) {
            const directUrl = String(
                data.coverUrl || 
                data.imageUrl || 
                data.image || 
                data.thumbnail || 
                data.cover || 
                ''
            ).trim();
            
            if (directUrl) {
                return directUrl.replace(/^http:\/\//, 'https://');
            }
            
            if (data.isbn) {
                const isbn = String(data.isbn).replace(/[^0-9X]/gi, '');
                if (isbn.length >= 10) {
                    return `https://covers.openlibrary.org/b/isbn/${isbn}-L.jpg`;
                }
            }
            
            if (data.olid || data.openLibraryId) {
                const olid = String(data.olid || data.openLibraryId).trim();
                if (olid) {
                    return `https://covers.openlibrary.org/b/olid/${olid}-L.jpg`;
                }
            }
            
            return '';
        }
        
        // Replace image with text cover
        function replaceWithTextCover(container, book) {
            container.innerHTML = `
                <div class="relative bg-gradient-to-br from-gray-700 to-gray-800 flex items-center justify-center w-full h-full">
                    <div class="text-center px-4">
                        <div class="text-base font-semibold text-white line-clamp-3">${book.title}</div>
                        <div class="mt-1 text-sm text-white/80 line-clamp-1">by ${book.author}</div>
                    </div>
                </div>
            `;
        }
        
        // Show error message
        function showError(message) {
            document.getElementById('curator-header').innerHTML = `
                <div class="absolute inset-0 bg-gradient-to-b from-black/40 to-black/70"></div>
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 h-full flex flex-col justify-center items-center">
                    <div class="text-white text-center relative z-10">
                        <h1 class="text-3xl md:text-5xl font-bold mb-4">Book Club Not Found</h1>
                        <p class="text-xl text-white/80">${message}</p>
                        <a href="welcome.html" class="inline-block mt-6 bg-forest-accent hover:bg-forest-accent-hover text-white font-semibold py-3 px-8 rounded-full transition-all duration-300">
                            Return to Home
                        </a>
                    </div>
                </div>
            `;
            
            document.getElementById('reading-lists').innerHTML = '';
            document.querySelector('.bg-white.rounded-xl').remove();
        }
        
        // Load the curator page when the DOM is ready
        document.addEventListener('DOMContentLoaded', loadCuratorPage);
    </script>
    
    <!-- Mobile Navigation Script -->
    <script src="assets/nav.js"></script>
</body>
</html>
