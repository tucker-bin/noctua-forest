<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <title>Admin Dashboard - Noctua Forest</title>
    <link rel="icon" type="image/png" href="../favicon.png">
    <link rel="stylesheet" href="../assets/tailwind.css">
    <!-- Tailwind is precompiled into assets/tailwind.css; CDN config not needed -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;700&family=Noto+Serif:wght@400;600;700&family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0ZWN1Z3DYQ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-0ZWN1Z3DYQ');
    </script>
</head>
<body class="bg-[#fbebcc] text-gray-800">
    <!-- Skip Link -->
    <a href="#main" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-white p-4 rounded shadow">Skip to main content</a>

    <!-- Header -->
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <header class="flex justify-between items-center">
            <a href="../welcome.html" class="flex items-center space-x-3">
                <img src="../images/logo.png" alt="Noctua Forest Logo" width="40" height="40" decoding="async" class="w-10 h-10">
                <span class="text-2xl font-bold" style="font-family: 'Poppins', sans-serif; color: #4A5450;">Noctua Forest</span>
            </a>
            <nav class="flex items-center space-x-8">
                <span id="adminEmail" class="text-forest-card"></span>
                <a href="../dashboard.html" class="text-forest-card hover:text-forest-accent bg-forest-accent text-white px-3 py-1 rounded">User Dashboard</a>
                <a href="../book-clubs.html" class="text-forest-card hover:text-forest-accent">Book Clubs</a>
                <a href="./email-logs.html" class="text-forest-card hover:text-forest-accent">Email Logs</a>
                <button id="signout" class="text-forest-card hover:text-forest-accent">Sign Out</button>
            </nav>
        </header>
    </div>

    <main id="main" class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="bg-forest-card rounded-xl p-8 mb-12">
            <h1 class="text-3xl font-bold mb-8 text-white">Admin Dashboard</h1>
            
            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-forest-secondary text-white rounded-lg p-6">
                    <div class="flex items-center mb-2">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                        <h3 class="text-lg font-semibold">Pending Submissions</h3>
                    </div>
                    <p id="pendingCount" class="text-3xl font-bold">0</p>
                </div>
                <div class="bg-forest-secondary text-white rounded-lg p-6">
                    <div class="flex items-center mb-2">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                        </svg>
                        <h3 class="text-lg font-semibold">Applications</h3>
                    </div>
                    <p id="applicationsCount" class="text-3xl font-bold">0</p>
                </div>
                <div class="bg-forest-accent text-white rounded-lg p-6">
                    <div class="flex items-center mb-2">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                        <h3 class="text-lg font-semibold">System Health</h3>
                    </div>
                    <p id="systemHealth" class="text-3xl font-bold text-green-400">Healthy</p>
                </div>
            </div>
        </div>

        <!-- Curator Clicks Overview -->
        <div class="bg-forest-card rounded-xl p-8 mb-12">
            <div class="flex items-center mb-6">
                <svg class="w-7 h-7 mr-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 11V3a1 1 0 112 0v8h8a1 1 0 110 2h-8v8a1 1 0 11-2 0v-8H3a1 1 0 110-2h8z" />
                </svg>
                <h2 class="text-2xl font-bold text-white">Curator Clicks</h2>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="bg-forest-secondary text-white rounded-lg p-6">
                    <div class="text-sm text-white/80">Last 24h</div>
                    <div id="aff24h" class="text-3xl font-bold">0</div>
                </div>
                <div class="bg-forest-secondary text-white rounded-lg p-6">
                    <div class="text-sm text-white/80">Last 7 days</div>
                    <div id="aff7d" class="text-3xl font-bold">0</div>
                </div>
                <div class="bg-forest-secondary text-white rounded-lg p-6">
                    <div class="text-sm text-white/80">Total (500 shown)</div>
                    <div id="affTotal" class="text-3xl font-bold">0</div>
                </div>
            </div>
            <div class="overflow-auto bg-forest-secondary rounded-lg">
                <table class="min-w-full text-left text-sm text-white/90">
                    <thead class="bg-[#3A4440] text-white">
                        <tr>
                            <th class="px-4 py-2">Time</th>
                            <th class="px-4 py-2">Ref</th>
                            <th class="px-4 py-2">Vendor</th>
                            <th class="px-4 py-2">Book</th>
                            <th class="px-4 py-2">Author</th>
                            <th class="px-4 py-2">Book ID</th>
                            <th class="px-4 py-2">UA</th>
                        </tr>
                    </thead>
                    <tbody id="affTable">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Maintenance Tools -->
        <div class="bg-forest-card rounded-xl p-8 mb-12">
            <div class="flex items-center mb-6">
                <svg class="w-7 h-7 mr-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v16h16M4 8h12" />
                </svg>
                <h2 class="text-2xl font-bold text-white">Maintenance</h2>
            </div>
            <div class="flex items-center gap-4">
                <button id="backfillPublishedAtBtn" class="px-6 py-2 bg-forest-accent hover:bg-forest-accent-hover text-white rounded-lg">Backfill publishedAt on books</button>
                <p class="text-sm text-white/80">Sets missing publishedAt to createdAt or now.</p>
            </div>
        </div>

        <!-- User Management -->
        <div class="bg-forest-card rounded-xl p-8 mb-12">
            <div class="flex items-center mb-6">
                <svg class="w-7 h-7 mr-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z" />
                </svg>
                <h2 class="text-2xl font-bold text-white">User Management</h2>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="bg-forest-secondary text-white rounded-lg p-6">
                    <div class="text-sm text-white/80">Total Users</div>
                    <div id="totalUsers" class="text-3xl font-bold">0</div>
                </div>
                <div class="bg-forest-secondary text-white rounded-lg p-6">
                    <div class="text-sm text-white/80">Active Today</div>
                    <div id="activeUsers" class="text-3xl font-bold">0</div>
                </div>
                <div class="bg-forest-secondary text-white rounded-lg p-6">
                    <div class="text-sm text-white/80">Curator Plus</div>
                    <div id="curatorPlusUsers" class="text-3xl font-bold">0</div>
                </div>
            </div>
            
            <div class="flex gap-4">
                <button id="viewAllUsers" class="px-6 py-2 bg-forest-accent hover:bg-forest-accent-hover text-white rounded-lg">
                    View All Users
                </button>
                <button id="manageMemberships" class="px-6 py-2 bg-forest-secondary hover:bg-forest-primary text-white rounded-lg">
                    Manage Memberships
                </button>
            </div>
        </div>

        <!-- Search Weights & Why Preview -->
        <div class="bg-forest-card rounded-xl p-8 mb-12">
            <div class="flex items-center mb-6">
                <svg class="w-7 h-7 mr-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                <h2 class="text-2xl font-bold text-white">Search Weights & Preview</h2>
            </div>
            <div class="grid md:grid-cols-3 gap-6 mb-6 text-white">
                <div class="bg-forest-secondary rounded-lg p-4">
                    <h3 class="text-sm font-semibold mb-2">Hybrid Weights</h3>
                    <div id="weightsView" class="text-white/90 text-sm"></div>
                </div>
                <div class="md:col-span-2 bg-forest-secondary rounded-lg p-4">
                    <h3 class="text-sm font-semibold mb-2">Why Chips Preview</h3>
                    <div class="flex gap-2 mb-3">
                        <input id="previewQuery" class="flex-1 px-4 py-2 rounded-lg bg-[#5A6560] border border-[#7A8580] text-white" placeholder="Type a query (e.g., fast technical intros for beginners)">
                        <button id="previewBtn" class="px-4 py-2 bg-forest-accent hover:bg-forest-accent-hover text-white rounded-lg">Preview</button>
                    </div>
                    <div id="whyPreview" class="min-h-[42px]"></div>
                </div>
            </div>
            <div class="text-white/70 text-xs">Weights are read-only here. Admin editing can be added later via Firestore config.</div>
        </div>
        <!-- Review Moderation -->
        <div class="bg-forest-card rounded-xl p-8 mb-12">
            <div class="flex items-center mb-6">
                <svg class="w-7 h-7 mr-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h2 class="text-2xl font-bold text-white">Review Moderation</h2>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="bg-forest-secondary text-white rounded-lg p-6">
                    <div class="text-sm text-white/80">Pending Reviews</div>
                    <div id="pendingReviewsCount" class="text-3xl font-bold">0</div>
                </div>
                <div class="bg-forest-secondary text-white rounded-lg p-6">
                    <div class="text-sm text-white/80">Flagged Content</div>
                    <div id="flaggedReviews" class="text-3xl font-bold">0</div>
                </div>
                <div class="bg-forest-secondary text-white rounded-lg p-6">
                    <div class="text-sm text-white/80">Moderated Today</div>
                    <div id="moderatedToday" class="text-3xl font-bold">0</div>
                </div>
            </div>
            
            <div class="flex gap-4">
                <button id="moderateReviews" class="px-6 py-2 bg-forest-accent hover:bg-forest-accent-hover text-white rounded-lg">
                    Moderate Reviews
                </button>
                <button id="viewFlagged" class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">
                    View Flagged Content
                </button>
                <a href="./moderation.html" class="px-6 py-2 bg-forest-secondary hover:bg-forest-primary text-white rounded-lg">
                    Full Moderation Panel
                </a>
            </div>
        </div>

        <!-- Review Book Submissions -->
        <div class="bg-forest-card rounded-xl p-8 mb-8">
            <div class="flex items-center mb-6">
                <svg class="w-7 h-7 mr-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                </svg>
                <h2 class="text-2xl font-bold text-white">Review Book Submissions</h2>
            </div>
            <div id="pendingSubmissions" class="space-y-4"></div>
        </div>

        <!-- Review Contributor Applications -->
        <div class="bg-forest-card rounded-xl p-8">
            <div class="flex items-center mb-6">
                <svg class="w-7 h-7 mr-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                </svg>
                <h2 class="text-2xl font-bold text-white">Review Applications</h2>
            </div>
            <div id="applicationsList" class="space-y-4"></div>
        </div>
        </div>
    </main>

    <!-- Preview Modal -->
    <div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
        <div class="bg-white rounded-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-8">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 id="previewTitle" class="text-2xl font-bold text-forest-card mb-2"></h2>
                        <p id="previewAuthor" class="text-gray-600"></p>
                    </div>
                    <button onclick="closePreview()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="space-y-6">
                    <div>
                        <h3 class="font-bold text-forest-card mb-2">Blurb</h3>
                        <p id="previewBlurb" class="text-gray-700"></p>
                    </div>
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <h3 class="font-bold text-forest-card mb-2">Language</h3>
                            <p id="previewLanguage" class="text-gray-700"></p>
                        </div>
                        <div>
                            <h3 class="font-bold text-forest-card mb-2">Region</h3>
                            <p id="previewRegion" class="text-gray-700"></p>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-bold text-forest-card mb-2">Cultural Themes</h3>
                        <p id="previewThemes" class="text-gray-700"></p>
                    </div>
                    <div>
                        <h3 class="font-bold text-forest-card mb-2">Genre Tags</h3>
                        <div id="previewTags" class="flex flex-wrap gap-2"></div>
                    </div>
                    <div>
                        <h3 class="font-bold text-forest-card mb-2">Links</h3>
                        <div class="space-y-2">
                            <p id="previewCover" class="text-gray-700"></p>
                            <p id="previewPdf" class="text-gray-700"></p>
                        </div>
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button onclick="closePreview()" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                        Close
                    </button>
                    <button id="previewApprove" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg">
                        Approve
                    </button>
                    <button id="previewReject" class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">
                        Reject
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { getAuth, onAuthStateChanged, signOut, getIdTokenResult } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js';
        import { 
            collection,
            query,
            where,
            orderBy,
            onSnapshot,
            doc,
            getDoc,
            getDocs,
            setDoc,
            updateDoc,
            deleteDoc,
            serverTimestamp,
            writeBatch
        } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';
        import { app as firebaseApp, db as firebaseDb } from '../firebase-config.js';

        // Use initialized Firebase
        const auth = getAuth(firebaseApp);
        const db = firebaseDb;

        // Email notification via backend
        async function sendApplicationEmail(toEmail, status, title, author) {
            try {
                const res = await fetch('/api/email/applications', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ to: toEmail, status, title, author })
                });
                if (!res.ok) throw new Error('Email failed');
            } catch (err) {
                console.warn('[email] failed', err);
            }
        }

        // Review management functions
        window.editReview = async (reviewId) => {
            // TODO: Implement review editor modal
            window.location.href = `edit-review.html?id=${reviewId}`;
        };

        window.toggleReviewStatus = async (reviewId, currentStatus) => {
            try {
                const newStatus = currentStatus === 'published' ? 'draft' : 'published';
                await updateDoc(doc(db, 'reviews', reviewId), {
                    status: newStatus,
                    lastUpdated: serverTimestamp()
                });
                alert(`Review ${newStatus === 'published' ? 'published' : 'unpublished'} successfully!`);
            } catch (error) {
                console.error('Error updating review status:', error);
                alert('Error updating review status. Please try again.');
            }
        };

        window.editBook = async (bookId) => {
            // TODO: Implement book editor modal
            window.location.href = `edit-book.html?id=${bookId}`;
        };

        window.removeBook = async (bookId) => {
            if (!confirm('Are you sure you want to remove this book? This action cannot be undone.')) return;

            try {
                await deleteDoc(doc(db, 'books', bookId));
                alert('Book removed successfully!');
            } catch (error) {
                console.error('Error removing book:', error);
                alert('Error removing book. Please try again.');
            }
        };

        // No dropdown; mirror user dashboard sign-out UX

        // Auth state observer
        onAuthStateChanged(auth, async (user) => {
            // console.log('[admin-check] onAuthStateChanged fired');
            if (!user) {
                window.location.href = '../account.html';
                return;
            }

            // Parallel admin checks
            let usersDocResult = undefined;
            let claimsResult = undefined;
            await Promise.all([
                (async () => {
                    try {
                        const snap = await getDoc(doc(db, 'users', user.uid));
                        if (snap.exists()) {
                            const data = snap.data();
                            usersDocResult = (data?.isAdmin === true || data?.admin === true);
                            // console.log('[admin-check] users doc isAdmin:', usersDocResult);
                        } else {
                            usersDocResult = false;
                            // console.log('[admin-check] users doc missing');
                        }
                    } catch (err) {
                        usersDocResult = undefined;
                        console.warn('[admin-check] users doc error:', err);
                    }
                })(),
                (async () => {
                    try {
                        await user.getIdToken(true);
                        const token = await getIdTokenResult(user);
                        claimsResult = (token.claims?.admin === true || token.claims?.isAdmin === true);
                        // console.log('[admin-check] claims isAdmin:', claimsResult, token.claims);
                    } catch (err) {
                        claimsResult = undefined;
                        console.warn('[admin-check] claims error:', err);
                    }
                })()
            ]);

            // Resolve conservatively to avoid flipping legit admins
            let isAdmin = (usersDocResult === true || claimsResult === true) || (usersDocResult === undefined || claimsResult === undefined);
            
            // Hardcoded admin check as fallback
            if (!isAdmin && user.email === 'tucker.apply@gmail.com') {
                console.log('[admin-check] Hardcoded admin check: Admin user detected');
                isAdmin = true;
            }
            
            // console.log('[admin-check] final decision isAdmin:', isAdmin);
            if (!isAdmin) {
                window.location.href = '../dashboard.html';
                return;
            }

            // Display admin email in both places
            const adminEmailEl = document.getElementById('adminEmail');
            const dropdownEmailEl = document.getElementById('dropdownEmail');
            if (adminEmailEl && dropdownEmailEl) {
                const email = user.email || 'Admin User';
                adminEmailEl.textContent = email;
                dropdownEmailEl.textContent = email;
            }
            
            // Add dashboard switcher for admin users
            if (user.email === 'tucker.apply@gmail.com') {
                const dashboardSwitcher = document.createElement('div');
                dashboardSwitcher.className = 'fixed top-4 right-4 z-50';
                dashboardSwitcher.innerHTML = `
                    <div class="bg-white rounded-lg shadow-lg p-3 border-2 border-red-600">
                        <div class="text-sm font-semibold text-forest-card mb-2">Dashboard Mode</div>
                        <div class="flex gap-2">
                            <button onclick="window.location.href='../dashboard.html'" class="px-3 py-1 bg-forest-accent text-white rounded text-xs">User View</button>
                            <button onclick="window.location.href='dashboard.html'" class="px-3 py-1 bg-red-600 text-white rounded text-xs">Admin View</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(dashboardSwitcher);
            }

            // Set up real-time listeners
            setupSubmissionsListener();
            setupReviewsListener();
            fetchCuratorEvents();
            // refresh every 60s
            setInterval(fetchCuratorEvents, 60000);

            // Wire up maintenance tools
            const backfillBtn = document.getElementById('backfillPublishedAtBtn');
            if (backfillBtn) backfillBtn.addEventListener('click', () => window.backfillPublishedAt());

            // Load and manage lists
            try { await loadLists(user.uid); } catch (e) { console.warn('loadLists failed', e); }
            wireListQuickCreate(user.uid);
            initWeightsPreview();
        });

        // Signout handler (same pattern as user dashboard)
        const signoutBtn = document.getElementById('signout');
        if (signoutBtn) {
            signoutBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                try {
                    await signOut(auth);
                    window.location.href = '../account.html';
                } catch (error) {
                    console.error('Error signing out:', error);
                    alert('Error signing out. Please try again.');
                }
            });
        }

        // Set up reviews listener
        function setupReviewsListener() {
            const q = query(collection(db, 'reviews'), orderBy('lastUpdated', 'desc'));
            onSnapshot(q, (snapshot) => {
                let reviewsWritten = 0;
                let pendingReviews = 0;
                const list = document.getElementById('pendingSubmissions');
                if (list) list.innerHTML = '';

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.status === 'published') reviewsWritten++;
                    if (data.status === 'draft') pendingReviews++;

                    if (list) {
                        const card = document.createElement('div');
                        card.className = 'bg-forest-secondary text-white p-6 rounded-lg flex justify-between items-start';
                        card.innerHTML = `
                            <div>
                                <h3 class="font-bold text-lg">${data.bookTitle || 'Untitled'}</h3>
                                <p class="text-gray-200">by ${data.bookAuthor || 'Unknown'}</p>
                                <p class="text-gray-300 mt-2">${(data.reviewText || '').slice(0,120)}${(data.reviewText||'').length>120?'...':''}</p>
                            </div>
                            <div class="flex space-x-3">
                                <button class="text-gray-200 hover:text-white" id="edit-${doc.id}">Edit</button>
                                <button class="text-green-200 hover:text-white" id="pub-${doc.id}">${data.status==='published'?'Unpublish':'Publish'}</button>
                            </div>`;
                        list.appendChild(card);
                        card.querySelector(`#edit-${doc.id}`)?.addEventListener('click', ()=>editReview(doc.id));
                        card.querySelector(`#pub-${doc.id}`)?.addEventListener('click', ()=>toggleReviewStatus(doc.id, data.status));
                    }
                });

                const reviewsCountEl = document.getElementById('reviewsCount');
                if (reviewsCountEl) reviewsCountEl.textContent = reviewsWritten;
                document.getElementById('pendingReviewsCount').textContent = pendingReviews;
            });
        }

        // Set up submissions listener
        function setupSubmissionsListener() {
            const q = query(collection(db, 'submissions'), where('approved','==', false), orderBy('createdAt','desc'));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('pendingSubmissions');
                if (container) container.innerHTML = '';
                document.getElementById('pendingCount').textContent = snapshot.size;

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (!container) return;
                    const card = document.createElement('div');
                    card.className = 'bg-forest-secondary text-white p-6 rounded-lg';
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-bold text-lg">${data.title}</h3>
                                <p class="text-gray-200">by ${data.author}</p>
                                <p class="text-gray-300 mt-2">${(data.blurb||'').slice(0,140)}${(data.blurb||'').length>140?'...':''}</p>
                            </div>
                            <div class="flex space-x-3">
                                <button class="text-gray-200 hover:text-white" id="view-${doc.id}">View</button>
                                <button class="text-green-200 hover:text-white" id="approve-${doc.id}">Approve</button>
                                <button class="text-red-200 hover:text-white" id="reject-${doc.id}">Reject</button>
                            </div>
                        </div>`;
                    container.appendChild(card);
                    card.querySelector(`#view-${doc.id}`)?.addEventListener('click', ()=>previewSubmission(doc.id));
                    card.querySelector(`#approve-${doc.id}`)?.addEventListener('click', ()=>approveSubmission(doc.id));
                    card.querySelector(`#reject-${doc.id}`)?.addEventListener('click', ()=>rejectSubmission(doc.id));
                });
            });
        }

        // Applications listener (Firestore collection: 'applications')
        (function setupApplicationsListener(){
            try {
                const q = query(collection(db, 'applications'), orderBy('createdAt', 'desc'));
                onSnapshot(q, (snapshot) => {
                    const container = document.getElementById('applicationsList');
                    if (container) container.innerHTML = '';
                    const countEl = document.getElementById('applicationsCount');
                    if (countEl) countEl.textContent = String(snapshot.size);

                    snapshot.forEach((docSnap) => {
                        const data = docSnap.data();
                        if (!container) return;
                        const card = document.createElement('div');
                        card.className = 'bg-forest-secondary text-white p-6 rounded-lg';
                        card.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-bold text-lg">${data.name || 'Unnamed applicant'}</h3>
                                    <p class="text-gray-200">Email: ${data.email || 'N/A'}</p>
                                    ${data.mediumUrl ? `<p class=\"text-gray-300 mt-2\">Medium: <a class=\"underline\" href=\"${data.mediumUrl}\" target=\"_blank\">${data.mediumUrl}</a></p>` : ''}
                                    ${data.message ? `<p class=\"text-gray-300 mt-2\">${String(data.message).slice(0,160)}${String(data.message||'').length>160?'...':''}</p>` : ''}
                                </div>
                                <div class="flex space-x-3">
                                    <button class="text-green-200 hover:text-white" id="app-approve-${docSnap.id}">Approve</button>
                                    <button class="text-red-200 hover:text-white" id="app-reject-${docSnap.id}">Reject</button>
                                </div>
                            </div>`;
                        container.appendChild(card);
                        card.querySelector(`#app-approve-${docSnap.id}`)?.addEventListener('click', async () => {
                            try {
                                await updateDoc(doc(db, 'applications', docSnap.id), { status: 'approved', reviewedAt: serverTimestamp() });
                                await sendApplicationEmail(data.email || '', 'approved', data.title, data.author);
                                alert('Application approved');
                            } catch (e) { console.error(e); alert('Failed to update application'); }
                        });
                        card.querySelector(`#app-reject-${docSnap.id}`)?.addEventListener('click', async () => {
                            if (!confirm('Reject this application?')) return;
                            try {
                                await updateDoc(doc(db, 'applications', docSnap.id), { status: 'rejected', reviewedAt: serverTimestamp() });
                                await sendApplicationEmail(data.email || '', 'rejected', data.title, data.author);
                                alert('Application rejected');
                            } catch (e) { console.error(e); alert('Failed to update application'); }
                        });
                    });
                });
            } catch (err) {
                console.warn('Applications listener failed:', err);
            }

            // Fetch curator events and update UI
            async function fetchCuratorEvents() {
                try {
                    const res = await fetch('/api/admin/affiliate-events');
                    const data = await res.json();
                    if (!data?.ok) return;
                    const events = Array.isArray(data.events) ? data.events : [];
                    const table = document.getElementById('affTable');
                    const last24h = Date.now() - 24*60*60*1000;
                    const last7d = Date.now() - 7*24*60*60*1000;
                    let c24 = 0, c7 = 0;
                    table.innerHTML = '';
                    events.forEach(ev => {
                        const when = new Date(ev.t || ev.ts || Date.now());
                        const tsMs = (typeof ev.t === 'number') ? ev.t : when.getTime();
                        if (tsMs >= last24h) c24++;
                        if (tsMs >= last7d) c7++;
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="px-4 py-2 whitespace-nowrap">${new Date(tsMs).toLocaleString()}</td>
                            <td class="px-4 py-2">${(ev.r||'—')}</td>
                            <td class="px-4 py-2">${(ev.vendor||'—')}</td>
                            <td class="px-4 py-2">${(ev.bTitle||'—')}</td>
                            <td class="px-4 py-2">${(ev.bAuthor||'—')}</td>
                            <td class="px-4 py-2">${(ev.bId||'—')}</td>
                            <td class="px-4 py-2 truncate max-w-[260px]">${(ev.ua||'').slice(0,120)}</td>
                        `;
                        table.appendChild(tr);
                    });
                    const totalEl = document.getElementById('affTotal');
                    const d24El = document.getElementById('aff24h');
                    const d7El = document.getElementById('aff7d');
                    if (totalEl) totalEl.textContent = String(events.length);
                    if (d24El) d24El.textContent = String(c24);
                    if (d7El) d7El.textContent = String(c7);
                } catch (e) {
                    console.warn('affiliate events load failed', e);
                }
            }
        })();

        // Set up published books listener
        function setupPublishedBooksListener() {
            const q = query(
                collection(db, 'books'),
                orderBy('publishedAt', 'desc')
            );

            onSnapshot(q, (snapshot) => {
                const publishedTable = document.getElementById('publishedTable');
                publishedTable.innerHTML = '';
                document.getElementById('publishedCount').textContent = snapshot.size;

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const row = document.createElement('tr');
                    
                    // Create and append cells safely
                    const cells = [
                        { text: data.title },
                        { text: data.author },
                        { text: new Date(data.publishedAt.toDate()).toLocaleDateString() },
                        { text: data.views || 0 },
                        {
                            content: [{
                                element: 'button',
                                text: 'Unpublish',
                                classes: ['text-red-600', 'hover:text-red-800'],
                                click: () => unpublishBook(doc.id)
                            }]
                        }
                    ];

                    cells.forEach(cell => {
                        const td = document.createElement('td');
                        td.className = 'px-6 py-4';
                        
                        if (cell.text !== undefined) {
                            td.textContent = cell.text;
                        } else if (cell.content) {
                            cell.content.forEach(item => {
                                const el = document.createElement(item.element);
                                el.textContent = item.text;
                                el.classList.add(...item.classes);
                                el.addEventListener('click', item.click);
                                td.appendChild(el);
                            });
                        }
                        
                        row.appendChild(td);
                    });
                    publishedTable.appendChild(row);
                });
            });
        }

        // Maintenance: Backfill publishedAt for existing books
        window.backfillPublishedAt = async () => {
            if (!confirm('Backfill publishedAt on books missing it? This will write timestamps.')) return;
            try {
                const snap = await getDocs(query(collection(db, 'books')));
                let batch = writeBatch(db);
                let ops = 0;
                let updated = 0;
                snap.forEach((docSnap) => {
                    const data = docSnap.data();
                    if (!data.publishedAt) {
                        const ref = doc(db, 'books', docSnap.id);
                        const useCreatedAt = (data.createdAt && typeof data.createdAt.toDate === 'function');
                        batch.update(ref, { publishedAt: useCreatedAt ? data.createdAt : serverTimestamp() });
                        ops++; updated++;
                        if (ops >= 450) {
                            batch.commit();
                            batch = writeBatch(db);
                            ops = 0;
                        }
                    }
                });
                if (ops > 0) await batch.commit();
                alert(`Backfill complete. Updated ${updated} book(s).`);
            } catch (e) {
                console.error('Backfill failed', e);
                alert('Backfill failed. See console for details.');
            }
        };

        // Approve submission -> publish book pipeline
        window.approveSubmission = async (submissionId) => {
            try {
                const submissionRef = doc(db, 'submissions', submissionId);
                const subSnap = await getDoc(submissionRef);
                if (!subSnap.exists()) throw new Error('Submission not found');
                const s = subSnap.data();

                // Normalize payload for books collection
                const bookPayload = {
                    title: s.title || 'Untitled',
                    author: s.author || 'Unknown',
                    publisher: s.publisher || '',
                    blurb: s.blurb || '',
                    primaryLanguage: s.primaryLanguage || '',
                    originalLanguage: s.originalLanguage || '',
                    authorRegion: s.authorRegion || '',
                    publicationYear: s.publicationYear || null,
                    culturalThemes: s.culturalThemes || '',
                    authorTags: s.authorTags || '',
                    targetAudience: s.targetAudience || '',
                    bookLength: s.bookLength || '',
                    coverUrl: s.coverUrl || '',
                    pdfUrl: s.pdfUrl || '',
                    purchaseLink: s.purchaseLink || '',
                    purchaseLink2: s.purchaseLink2 || '',
                    amazonUrl: s.amazonUrl || '',
                    isbn: s.isbn || '',
                    premium: s.premium === true,
                    userId: s.userId || '',
                    views: 0,
                    publishedAt: serverTimestamp(),
                };

                const bookRef = doc(collection(db, 'books'));
                await setDoc(bookRef, bookPayload);

                await updateDoc(submissionRef, {
                    approved: true,
                    approvedAt: serverTimestamp(),
                    bookId: bookRef.id
                });

                if (confirm('Published. View book page?')) {
                    window.open(`../book.html?id=${bookRef.id}`, '_blank');
                } else {
                    alert('Submission approved and published successfully!');
                }
            } catch (error) {
                console.error('Error approving submission:', error);
                alert('Error approving submission. Please try again.');
            }
        };

        // Reject submission
        window.rejectSubmission = async (submissionId) => {
            if (!confirm('Are you sure you want to reject this submission?')) return;

            try {
                await deleteDoc(doc(db, 'submissions', submissionId));
                alert('Submission rejected successfully!');
            } catch (error) {
                console.error('Error rejecting submission:', error);
                alert('Error rejecting submission. Please try again.');
            }
        };

        // Unpublish book
        window.unpublishBook = async (bookId) => {
            if (!confirm('Are you sure you want to unpublish this book?')) return;

            try {
                await deleteDoc(doc(db, 'books', bookId));
                alert('Book unpublished successfully!');
            } catch (error) {
                console.error('Error unpublishing book:', error);
                alert('Error unpublishing book. Please try again.');
            }
        };

        // Preview submission
        let currentSubmissionId = null;
        const previewModal = document.getElementById('previewModal');
        const previewTitle = document.getElementById('previewTitle');
        const previewAuthor = document.getElementById('previewAuthor');
        const previewBlurb = document.getElementById('previewBlurb');
        const previewLanguage = document.getElementById('previewLanguage');
        const previewRegion = document.getElementById('previewRegion');
        const previewThemes = document.getElementById('previewThemes');
        const previewTags = document.getElementById('previewTags');
        const previewCover = document.getElementById('previewCover');
        const previewPdf = document.getElementById('previewPdf');
        const previewApprove = document.getElementById('previewApprove');
        const previewReject = document.getElementById('previewReject');

        window.previewSubmission = async (submissionId) => {
            try {
                const submissionDoc = await getDoc(doc(db, 'submissions', submissionId));
                if (!submissionDoc.exists()) {
                    alert('Submission not found');
                    return;
                }

                const data = submissionDoc.data();
                currentSubmissionId = submissionId;

                // Fill preview data
                previewTitle.textContent = data.title;
                previewAuthor.textContent = data.author;
                previewBlurb.textContent = data.blurb;
                previewLanguage.textContent = data.primaryLanguage || 'Not specified';
                previewRegion.textContent = data.authorRegion || 'Not specified';
                previewThemes.textContent = data.culturalThemes || 'None specified';
                
                // Handle tags
                previewTags.innerHTML = '';
                if (data.authorTags) {
                    data.authorTags.split(',').forEach(tag => {
                        const span = document.createElement('span');
                        span.className = 'px-2 py-1 bg-forest-card text-white rounded text-sm';
                        span.textContent = tag.trim();
                        previewTags.appendChild(span);
                    });
                } else {
                    previewTags.textContent = 'No tags';
                }

                // Handle links
                previewCover.innerHTML = data.coverUrl ? 
                    `Cover: <a href="${data.coverUrl}" target="_blank" class="text-blue-600 hover:text-blue-800">View</a>` :
                    'No cover image provided';
                previewPdf.innerHTML = data.pdfUrl ?
                    `PDF: <a href="${data.pdfUrl}" target="_blank" class="text-blue-600 hover:text-blue-800">View</a>` :
                    'No PDF provided';

                // Show modal
                previewModal.classList.remove('hidden');
                previewModal.classList.add('flex');

                // Set up action buttons
                previewApprove.onclick = () => {
                    approveSubmission(currentSubmissionId);
                    closePreview();
                };
                previewReject.onclick = () => {
                    rejectSubmission(currentSubmissionId);
                    closePreview();
                };
            } catch (error) {
                console.error('Error loading preview:', error);
                alert('Error loading preview. Please try again.');
            }
        };

        window.closePreview = () => {
            previewModal.classList.add('hidden');
            previewModal.classList.remove('flex');
            currentSubmissionId = null;
        };
    </script>
    <script>
      // Lists quick-manage (client-only minimal UI)
      async function loadLists(userId){
        try{
          const { getUserListsSummary } = await import('../js/readingListService.js');
          const lists = await getUserListsSummary(userId);
          const tbody = document.getElementById('listsTable');
          if (!tbody) return;
          tbody.innerHTML = '';
          (lists || []).forEach((l, idx) => {
            const tr = document.createElement('tr');
            tr.setAttribute('draggable','true');
            tr.dataset.id = l.id;
            tr.innerHTML = `
              <td class="px-4 py-2 cursor-move">${idx+1}</td>
              <td class="px-4 py-2">${l.name || 'Untitled'}</td>
              <td class="px-4 py-2">${(l.books||[]).length}</td>
              <td class="px-4 py-2">${l.views||0}</td>
              <td class="px-4 py-2">${l.clicks||0}</td>
              <td class="px-4 py-2">
                <a class="underline mr-3" target="_blank" href="../lists.html?id=${l.shareId || l.id}">Open</a>
              </td>`;
            tbody.appendChild(tr);
          });
          enableReorder(tbody, userId);
        }catch(e){ console.warn(e); }
      }

      function enableReorder(tbody, userId){
        let dragging = null;
        tbody.querySelectorAll('tr').forEach(row => {
          row.addEventListener('dragstart', ()=> dragging = row);
          row.addEventListener('dragover', (e)=>{ e.preventDefault(); const after = e.target.closest('tr'); if(after && after!==dragging){ tbody.insertBefore(dragging, after); }});
          row.addEventListener('drop', async ()=>{ await persistOrder(tbody, userId); });
        });
      }

      async function persistOrder(tbody, userId){
        try{
          const order = Array.from(tbody.querySelectorAll('tr')).map((tr, i)=>({ id: tr.dataset.id, index: i }));
          const { saveListOrder } = await import('../js/readingListService.js');
          await saveListOrder(userId, order);
        }catch(e){ console.warn('save order failed', e); }
      }

      function wireListQuickCreate(userId){
        const btn = document.getElementById('createListBtn');
        if (!btn) return;
        btn.addEventListener('click', async ()=>{
          try{
            const name = document.getElementById('newListName').value.trim();
            const description = document.getElementById('newListDesc').value.trim();
            if (!name) { alert('Enter a list name'); return; }
            const { createList } = await import('../js/readingListService.js');
            await createList(userId, { name, description });
            document.getElementById('newListName').value = '';
            document.getElementById('newListDesc').value = '';
            await loadLists(userId);
          }catch(e){ console.error(e); alert('Failed to create list'); }
        });
      }

      // Weights preview + Why chips
      function initWeightsPreview(){
        const el = document.getElementById('weightsView');
        if (el){
          const w = (window.FOREST_WEIGHTS || { cosine:0.6, tagOverlap:0.2, popularity:0.2 });
          el.textContent = `cosine: ${w.cosine ?? 0.6}, tagOverlap: ${w.tagOverlap ?? 0.2}, popularity: ${w.popularity ?? 0.2}`;
        }
        const btn = document.getElementById('previewBtn');
        if (!btn) return;
        btn.addEventListener('click', ()=>{
          const q = document.getElementById('previewQuery').value || '';
          // reuse client parser from Forest (minimal duplicate)
          const chips = buildWhyFromQuery(q);
          document.getElementById('whyPreview').innerHTML = chips || '<span class="text-white/70 text-sm">No facets detected.</span>';
        });
      }
      function buildWhyFromQuery(q){
        const dict = {
          audience:['kids','children','teens','students','beginners','founders','developers','physicians','doctors','nurses','teachers','parents'],
          tone:['technical','academic','practical','hands-on','light-hearted','humorous','serious','inspirational'],
          pace:['fast','quick','short','breezy','deep','comprehensive','in-depth','slow'],
          domain:['health','medicine','nutrition','finance','investing','history','tech','software','design','psychology','productivity','business','leadership'],
          goal:['learn','study','revise','relax','entertain','diet','lose weight','build','ship','launch']
        };
        const n = (q||'').toLowerCase();
        const facets = { audience:[], tone:[], pace:[], domain:[], goal:[] };
        Object.entries(dict).forEach(([k,list])=>{ list.forEach(w=>{ if(new RegExp(`(^|\\s)${w}(\\s|$)`).test(n)) facets[k].push(w); }); });
        const show=[]; if(facets.audience[0]) show.push(`for ${facets.audience[0]}`); if(facets.tone[0]) show.push(facets.tone[0]); if(facets.pace[0]) show.push(facets.pace[0]); if(facets.domain[0]) show.push(facets.domain[0]); if(facets.goal[0]) show.push(facets.goal[0]);
        if (!show.length) return '';
        return `<div>${show.slice(0,3).map(t=>`<span class=\"inline-block text-xs bg-gray-100 text-forest-text px-2 py-1 rounded mr-2 mb-2\">${t}</span>`).join('')}</div>`;
      }
    </script>
    
    <!-- Global Footer with Google Translate -->
    <script src="../assets/footer.js"></script>
</body>
</html>
