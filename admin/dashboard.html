<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://www.gstatic.com; script-src 'self' https://www.gstatic.com https://cdn.tailwindcss.com 'unsafe-inline'; style-src 'self' https://fonts.googleapis.com 'unsafe-inline'; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <title>Admin Dashboard - Noctua Forest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'forest': {
                'deep': '#fbebcc',
                'card': '#4A5450',
                'light': '#E0E2DB',
                'accent': '#F58220',
                'secondary': '#5A6560'
              }
            },
            fontFamily: {
              'sans': ['Inter', 'sans-serif'],
              'heading': ['Poppins', 'serif'],
            }
          }
        }
      }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-[#fbebcc] text-gray-800">
    <!-- Skip Link -->
    <a href="#main" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-white p-4 rounded shadow">Skip to main content</a>

    <!-- Header -->
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <header class="flex justify-between items-center">
            <a href="../welcome.html" class="flex items-center space-x-3">
                <img src="../images/logo.png" alt="Noctua Forest Logo" class="w-10 h-10">
                <span class="text-2xl font-bold" style="font-family: 'Poppins', sans-serif; color: #4A5450;">Noctua Forest</span>
            </a>
            <nav class="flex items-center space-x-8">
                <span id="adminEmail" class="text-forest-card"></span>
                <button id="logoutBtn" class="text-forest-card hover:text-forest-accent">Logout</button>
            </nav>
        </header>
    </div>

    <main id="main" class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="bg-white rounded-xl shadow-sm p-8">
            <h1 class="text-3xl font-bold mb-8 text-forest-card">Admin Dashboard</h1>
            
            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                <div class="bg-forest-card text-white rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-2">Pending Submissions</h3>
                    <p id="pendingCount" class="text-3xl font-bold">0</p>
                </div>
                <div class="bg-forest-secondary text-white rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-2">Published Books</h3>
                    <p id="publishedCount" class="text-3xl font-bold">0</p>
                </div>
                <div class="bg-forest-accent text-white rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-2">Premium Reviews</h3>
                    <p id="premiumCount" class="text-3xl font-bold">0</p>
                </div>
            </div>

            <!-- Submissions Table -->
            <div class="mb-12">
                <h2 class="text-2xl font-bold mb-6 text-forest-card">Recent Submissions</h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-forest-card text-white">
                            <tr>
                                <th class="px-6 py-3 text-left">Title</th>
                                <th class="px-6 py-3 text-left">Author</th>
                                <th class="px-6 py-3 text-left">Submitted</th>
                                <th class="px-6 py-3 text-left">Premium</th>
                                <th class="px-6 py-3 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="submissionsTable" class="divide-y divide-gray-200">
                            <!-- Submissions will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Published Books -->
            <div>
                <h2 class="text-2xl font-bold mb-6 text-forest-card">Published Books</h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-forest-card text-white">
                            <tr>
                                <th class="px-6 py-3 text-left">Title</th>
                                <th class="px-6 py-3 text-left">Author</th>
                                <th class="px-6 py-3 text-left">Published</th>
                                <th class="px-6 py-3 text-left">Views</th>
                                <th class="px-6 py-3 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="publishedTable" class="divide-y divide-gray-200">
                            <!-- Published books will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            onAuthStateChanged,
            signOut 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore,
            collection,
            query,
            where,
            orderBy,
            onSnapshot,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            serverTimestamp
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import firebaseConfig from '../firebase-config.js';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Auth state observer
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            // Check if user is admin
            const userDoc = await getDoc(doc(db, 'users', user.uid));
            if (!userDoc.exists() || !userDoc.data().isAdmin) {
                signOut(auth);
                window.location.href = 'login.html';
                return;
            }

            // Display admin email
            document.getElementById('adminEmail').textContent = user.email;

            // Set up real-time listeners
            setupSubmissionsListener();
            setupPublishedBooksListener();
        });

        // Logout handler
        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.href = 'login.html';
            });
        });

        // Set up submissions listener
        function setupSubmissionsListener() {
            const q = query(
                collection(db, 'submissions'),
                orderBy('createdAt', 'desc')
            );

            onSnapshot(q, (snapshot) => {
                let pendingCount = 0;
                let premiumCount = 0;
                const submissionsTable = document.getElementById('submissionsTable');
                submissionsTable.innerHTML = '';

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (!data.approved) pendingCount++;
                    if (data.premium) premiumCount++;

                    const row = document.createElement('tr');
                    
                    // Create and append cells safely
                    const cells = [
                        { text: data.title },
                        { text: data.author },
                        { text: new Date(data.createdAt.toDate()).toLocaleDateString() },
                        { text: data.premium ? 'âœ“' : '' },
                        {
                            content: [
                                { 
                                    element: 'button',
                                    text: 'Approve',
                                    classes: ['text-green-600', 'hover:text-green-800', 'mr-3'],
                                    click: () => approveSubmission(doc.id)
                                },
                                {
                                    element: 'button',
                                    text: 'Reject',
                                    classes: ['text-red-600', 'hover:text-red-800'],
                                    click: () => rejectSubmission(doc.id)
                                }
                            ]
                        }
                    ];

                    cells.forEach(cell => {
                        const td = document.createElement('td');
                        td.className = 'px-6 py-4';
                        
                        if (cell.text !== undefined) {
                            td.textContent = cell.text;
                        } else if (cell.content) {
                            cell.content.forEach(item => {
                                const el = document.createElement(item.element);
                                el.textContent = item.text;
                                el.classList.add(...item.classes);
                                el.addEventListener('click', item.click);
                                td.appendChild(el);
                            });
                        }
                        
                        row.appendChild(td);
                    });
                    submissionsTable.appendChild(row);
                });

                document.getElementById('pendingCount').textContent = pendingCount;
                document.getElementById('premiumCount').textContent = premiumCount;
            });
        }

        // Set up published books listener
        function setupPublishedBooksListener() {
            const q = query(
                collection(db, 'books'),
                orderBy('publishedAt', 'desc')
            );

            onSnapshot(q, (snapshot) => {
                const publishedTable = document.getElementById('publishedTable');
                publishedTable.innerHTML = '';
                document.getElementById('publishedCount').textContent = snapshot.size;

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const row = document.createElement('tr');
                    
                    // Create and append cells safely
                    const cells = [
                        { text: data.title },
                        { text: data.author },
                        { text: new Date(data.publishedAt.toDate()).toLocaleDateString() },
                        { text: data.views || 0 },
                        {
                            content: [{
                                element: 'button',
                                text: 'Unpublish',
                                classes: ['text-red-600', 'hover:text-red-800'],
                                click: () => unpublishBook(doc.id)
                            }]
                        }
                    ];

                    cells.forEach(cell => {
                        const td = document.createElement('td');
                        td.className = 'px-6 py-4';
                        
                        if (cell.text !== undefined) {
                            td.textContent = cell.text;
                        } else if (cell.content) {
                            cell.content.forEach(item => {
                                const el = document.createElement(item.element);
                                el.textContent = item.text;
                                el.classList.add(...item.classes);
                                el.addEventListener('click', item.click);
                                td.appendChild(el);
                            });
                        }
                        
                        row.appendChild(td);
                    });
                    publishedTable.appendChild(row);
                });
            });
        }

        // Approve submission
        window.approveSubmission = async (submissionId) => {
            try {
                const submissionRef = doc(db, 'submissions', submissionId);
                const submissionDoc = await getDoc(submissionRef);
                const submissionData = submissionDoc.data();

                // Create new book document
                const bookRef = doc(collection(db, 'books'));
                await setDoc(bookRef, {
                    ...submissionData,
                    publishedAt: serverTimestamp(),
                    views: 0
                });

                // Update submission status
                await updateDoc(submissionRef, {
                    approved: true,
                    approvedAt: serverTimestamp(),
                    bookId: bookRef.id
                });

                alert('Submission approved and published successfully!');
            } catch (error) {
                console.error('Error approving submission:', error);
                alert('Error approving submission. Please try again.');
            }
        };

        // Reject submission
        window.rejectSubmission = async (submissionId) => {
            if (!confirm('Are you sure you want to reject this submission?')) return;

            try {
                await deleteDoc(doc(db, 'submissions', submissionId));
                alert('Submission rejected successfully!');
            } catch (error) {
                console.error('Error rejecting submission:', error);
                alert('Error rejecting submission. Please try again.');
            }
        };

        // Unpublish book
        window.unpublishBook = async (bookId) => {
            if (!confirm('Are you sure you want to unpublish this book?')) return;

            try {
                await deleteDoc(doc(db, 'books', bookId));
                alert('Book unpublished successfully!');
            } catch (error) {
                console.error('Error unpublishing book:', error);
                alert('Error unpublishing book. Please try again.');
            }
        };
    </script>
</body>
</html>
