<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share Your Review - Noctua Forest</title>
    <meta name="description" content="Share your authentic book review with The Forest community. Help other readers discover great books through your honest perspective.">
    
    <!-- Favicon -->
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    
    <!-- Preconnect to external domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;700&family=Noto+Serif:wght@400;600;700&family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0ZWN1Z3DYQ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-0ZWN1Z3DYQ');
    </script>
    <style>
        body {
            font-family: 'Noto Sans', sans-serif;
            background-color: #fbebcc;
            color: #2D3748;
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        .header {
            background: linear-gradient(135deg, #4A5450 0%, #3A4440 100%);
            color: white;
            padding: 2rem 0;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
            color: #E0E2DB;
        }
        
        .header p {
            font-size: 1.1rem;
            margin: 0.5rem 0 0 0;
            color: #B8BDB5;
        }
        
        .main-content {
            padding: 3rem 0;
        }
        
        .form-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #7A8580;
            border-radius: 0.5rem;
            background-color: #5A6560;
            color: white;
            font-size: 1rem;
            transition: border-color 0.2s, background-color 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #F58220;
            background-color: #6A7570;
        }
        
        .form-input::placeholder {
            color: #B8BDB5;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #F58220 0%, #E6731A 100%);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #E6731A 0%, #D66414 100%);
            transform: translateY(-1px);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .chat-message {
            margin-bottom: 1rem;
        }
        
        .chat-message.bot .flex {
            justify-content: flex-start;
        }
        
        .chat-message.user .flex {
            justify-content: flex-end;
        }
        
        .hidden {
            display: none !important;
        }
        
        .touch-spacing {
            margin-bottom: 1.5rem;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .main-content {
                padding: 2rem 0;
            }
            
            .container {
                padding: 0 0.5rem;
            }
        }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <script src="components/Navigation.js"></script>
    
    <!-- Header -->
    <header class="header">
        <div class="container">
            <h1>Share Your Review</h1>
            <p>Help other readers discover great books through your authentic perspective</p>
            </div>
        </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <div class="form-container">
                <!-- Conversational Review Interface -->
                <div id="reviewChat" class="bg-[#4A5450] rounded-xl p-4 md:p-8 text-white">
                    <!-- Chat Messages Container -->
                    <div id="chatMessages" class="space-y-4 mb-6 max-h-96 overflow-y-auto">
                        <!-- Messages will be added dynamically -->
            </div>

                    <!-- Current Input -->
                    <div id="chatInput" class="space-y-4">
                        <div id="currentQuestion" class="chat-message bot">
                        <div class="flex items-start space-x-3">
                                <div class="w-8 h-8 bg-forest-accent rounded-full flex items-center justify-center text-sm">ðŸ¦‰</div>
                                <div class="bg-[#5A6560] rounded-lg p-4 text-white max-w-md">
                                    Hi! What book would you like to share with The Forest?
                        </div>
                    </div>
                </div>

                        <div class="flex space-x-3">
                            <input 
                                id="userInput" 
                                type="text" 
                                placeholder="Book title or Amazon link..."
                                class="flex-1 form-input"
                                autocomplete="off"
                            >
                            <button 
                                id="sendButton" 
                                type="button" 
                                class="px-4 py-2 bg-forest-accent hover:bg-forest-accent-hover text-white rounded-lg transition-colors">
                                Send
                                </button>
                    </div>
                </div>

                    <!-- Hidden form fields for final submission -->
                    <div id="hiddenFields" class="hidden">
                        <input type="hidden" name="title" id="hiddenTitle">
                        <input type="hidden" name="author" id="hiddenAuthor">
                        <input type="hidden" name="primaryLanguage" id="hiddenLanguage">
                        <input type="hidden" name="authorRegion" id="hiddenRegion">
                        <input type="hidden" name="publicationYear" id="hiddenYear">
                        <input type="hidden" name="reviewText" id="hiddenReview">
                        <input type="hidden" name="motivation" id="hiddenMotivation">
                        <input type="hidden" name="audience" id="hiddenAudience">
                        <input type="hidden" name="contentWarnings" id="hiddenWarnings">
                        <input type="hidden" name="amazonUrl" id="hiddenAmazonUrl">
                </div>

                    <!-- Submit button (appears at end) -->
                    <button 
                        id="finalSubmit" 
                        type="submit" 
                        class="hidden w-full mt-6 btn-primary">
                        Publish Your Review
                    </button>
                    
                    <div id="submissionStatus" class="mt-3 text-sm text-gray-200"></div>
                    </div>
                </div>
            </div>
    </main>

    <!-- Firebase Configuration -->
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
      import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js';
      import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';
      
      const firebaseConfig = {
        apiKey: "AIzaSyBQZQZQZQZQZQZQZQZQZQZQZQZQZQZQZQZQ",
        authDomain: "noctua-forest.firebaseapp.com",
        projectId: "noctua-forest",
        storageBucket: "noctua-forest.appspot.com",
        messagingSenderId: "123456789012",
        appId: "1:123456789012:web:abcdefghijklmnopqrstuvwxyz"
      };
      
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      
      // Make auth and db available globally
      window.auth = auth;
      window.db = db;
      
      // Check authentication status
      onAuthStateChanged(auth, (user) => {
        if (!user) {
          window.location.href = 'welcome.html';
        }
      });
    </script>

    <!-- Conversational Review Interface -->
    <script type="module">
      import { fetchBookMetadata, extractASIN } from './js/amazonService.js';
      import { submitReview } from './js/reviewService.js';
      
      class ConversationalReview {
        constructor() {
          this.currentStep = 0;
          this.responses = {};
          this.bookData = {};
          this.isSubmitting = false;
          
          this.questions = [
            {
              id: 'book_input',
              question: "Hi! What book would you like to share with The Forest?",
              placeholder: "Book title or Amazon link...",
              processor: this.processBookInput.bind(this),
              required: true
            },
            {
              id: 'motivation', 
              question: (data) => `Great choice! What drew you to "${data.title}"?`,
              placeholder: "e.g., friend recommended it, love the author, needed escapism...",
              processor: this.processMotivation.bind(this),
              required: true
            },
            {
              id: 'review',
              question: "How did it make you feel? What did you think?",
              placeholder: "Share your honest thoughts...",
              type: 'textarea',
              processor: this.processReview.bind(this),
              required: true
            },
            {
              id: 'audience',
              question: "Who else would connect with this book?",
              placeholder: "e.g., anyone going through change, parents of teens, history lovers...",
              processor: this.processAudience.bind(this),
              required: false
            },
            {
              id: 'warnings',
              question: "Any content warnings others should know about?",
              placeholder: "e.g., violence, difficult themes... or just say 'none'",
              processor: this.processWarnings.bind(this),
              required: false
            }
          ];
          
          this.init();
        }

        init() {
          this.setupEventListeners();
          this.showCurrentQuestion();
        }

        setupEventListeners() {
          const userInput = document.getElementById('userInput');
          const sendButton = document.getElementById('sendButton');
          const finalSubmit = document.getElementById('finalSubmit');

          // Send button click
          sendButton.addEventListener('click', () => this.handleUserInput());
          
          // Enter key in input
          userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              this.handleUserInput();
            }
          });

          // Final submit
          finalSubmit.addEventListener('click', () => this.submitReview());
        }

        async handleUserInput() {
          const userInput = document.getElementById('userInput');
          const input = userInput.value.trim();
          
          if (!input) return;

          // Add user message to chat
          this.addChatMessage('user', input);
          userInput.value = '';

          // Process the input
          const currentQuestion = this.questions[this.currentStep];
          const result = await currentQuestion.processor(input);
          
          if (result.success) {
            this.responses[currentQuestion.id] = input;
            this.currentStep++;
            
            if (this.currentStep < this.questions.length) {
              this.showCurrentQuestion();
            } else {
              this.showFinalSubmit();
            }
        } else {
            // Show error and ask again
            this.addChatMessage('bot', result.message);
          }
        }

        async processBookInput(input) {
          // Try Amazon URL first
          if (input.includes('amazon.com') || input.includes('amzn.to')) {
            try {
              const metadata = await fetchBookMetadata(input);
              this.bookData = metadata;
              
              // Populate hidden fields
              document.getElementById('hiddenTitle').value = metadata.title;
              document.getElementById('hiddenAuthor').value = metadata.author;
              document.getElementById('hiddenYear').value = this.extractYear(metadata.publicationDate);
              document.getElementById('hiddenAmazonUrl').value = input;
              
              return {
                message: `Found it! "${metadata.title}" by ${metadata.author} (${metadata.publicationDate})`,
                success: true
              };
            } catch (error) {
              return {
                message: "Couldn't fetch from that link. What's the book title?",
                success: false
              };
            }
          } else {
            // Manual title entry
            this.bookData.title = input;
            document.getElementById('hiddenTitle').value = input;
            return {
              message: `"${input}" - got it! Who's the author?`,
              success: true,
              followUp: 'author'
            };
          }
        }
        
        processMotivation(input) {
          this.responses.motivation = input;
          document.getElementById('hiddenMotivation').value = input;
          return { success: true };
        }
        
        processReview(input) {
          this.responses.review = input;
          document.getElementById('hiddenReview').value = input;
          return { success: true };
        }
        
        processAudience(input) {
          this.responses.audience = input;
          document.getElementById('hiddenAudience').value = input;
          return { success: true };
        }
        
        processWarnings(input) {
          this.responses.warnings = input;
          document.getElementById('hiddenWarnings').value = input;
          return { success: true };
        }

        showCurrentQuestion() {
          const currentQuestion = this.questions[this.currentStep];
          const questionText = typeof currentQuestion.question === 'function' 
            ? currentQuestion.question(this.bookData) 
            : currentQuestion.question;
          
          this.addChatMessage('bot', questionText);
          
          const userInput = document.getElementById('userInput');
          userInput.placeholder = currentQuestion.placeholder;
        }

        showFinalSubmit() {
          this.addChatMessage('bot', "Perfect! Ready to publish your review to The Forest?");
          document.getElementById('finalSubmit').classList.remove('hidden');
        }

        addChatMessage(sender, message) {
          const chatMessages = document.getElementById('chatMessages');
          const messageDiv = document.createElement('div');
          messageDiv.className = `chat-message ${sender}`;
          
          if (sender === 'bot') {
            messageDiv.innerHTML = `
              <div class="flex items-start space-x-3">
                <div class="w-8 h-8 bg-forest-accent rounded-full flex items-center justify-center text-sm">ðŸ¦‰</div>
                <div class="bg-[#5A6560] rounded-lg p-4 text-white max-w-md">
                  ${message}
                </div>
              </div>
            `;
          } else {
            messageDiv.innerHTML = `
              <div class="flex items-start space-x-3 justify-end">
                <div class="bg-forest-accent rounded-lg p-4 text-white max-w-md">
                  ${message}
                </div>
                <div class="w-8 h-8 bg-[#5A6560] rounded-full flex items-center justify-center text-sm">ðŸ‘¤</div>
              </div>
            `;
          }
          
          chatMessages.appendChild(messageDiv);
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        extractYear(dateString) {
          if (!dateString) return new Date().getFullYear();
          const year = new Date(dateString).getFullYear();
          return isNaN(year) ? new Date().getFullYear() : year;
        }

        async submitReview() {
          if (this.isSubmitting) return;
          this.isSubmitting = true;

          const finalSubmit = document.getElementById('finalSubmit');
          const originalText = finalSubmit.textContent;
          finalSubmit.textContent = 'Publishing...';
          finalSubmit.disabled = true;

          try {
            // Create book payload
            const bookPayload = {
              title: this.bookData.title,
              author: this.bookData.author || 'Unknown Author',
              primaryLanguage: 'en', // Default for now
              authorRegion: 'Unknown', // Default for now
              publicationYear: this.extractYear(this.bookData.publicationDate),
              publishedAt: new Date(),
              views: 0,
              popularity: 0,
              userId: window.auth.currentUser.uid
            };

            // Create review payload
            const reviewPayload = {
              bookId: '', // Will be set after book creation
              text: this.responses.review,
              authorId: window.auth.currentUser.uid,
              authorAvatarUrl: window.auth.currentUser.photoURL || '',
              motivation: this.responses.motivation,
              audience: this.responses.audience,
              contentWarnings: this.responses.warnings,
              hasReadBook: true,
              authenticReview: true,
              noAI: true
            };

            // Submit using existing review service
            const result = await submitReview({ ...bookPayload, ...reviewPayload });
            
            // Redirect to book page
            window.location.href = `book.html?id=${result.bookId}`;

          } catch (error) {
            console.error('Submission error:', error);
            this.addChatMessage('bot', `Sorry, there was an error: ${error.message}. Please try again.`);
          } finally {
            this.isSubmitting = false;
            finalSubmit.textContent = originalText;
            finalSubmit.disabled = false;
          }
        }
      }

      // Initialize when DOM is loaded
      document.addEventListener('DOMContentLoaded', function() {
        const conversationalReview = new ConversationalReview();
      });
    </script>

    <!-- Global Footer with Google Translate -->
    <script src="assets/footer.js"></script>
    
    <script src="assets/nav.js"></script>
  </body>
</html>
