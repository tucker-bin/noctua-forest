<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share Your Review - Noctua Forest</title>
    <meta name="description" content="Share your authentic book review with The Forest community. Help other readers discover great books through your honest perspective.">
    
    <!-- Favicon -->
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    
    <!-- Preconnect to external domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;700&family=Noto+Serif:wght@400;600;700&family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Styles -->
    <link rel="stylesheet" href="assets/tailwind.css">
    <link rel="stylesheet" href="assets/base-styles.css">
    <link rel="stylesheet" href="assets/nav.css">
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0ZWN1Z3DYQ" onerror="console.warn('Google Analytics failed to load')"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-0ZWN1Z3DYQ');
    </script>
    <style>
        body {
            font-family: 'Noto Sans', sans-serif;
            background-color: #fbebcc;
            color: #2D3748;
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        .main-content {
            padding: 3rem 0;
        }
        
        .form-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #7A8580;
            border-radius: 0.5rem;
            background-color: #5A6560;
            color: white;
            font-size: 1rem;
            transition: border-color 0.2s, background-color 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #F58220;
            background-color: #6A7570;
        }
        
        .form-input::placeholder {
            color: #B8BDB5;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #F58220 0%, #E6731A 100%);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #E6731A 0%, #D66414 100%);
            transform: translateY(-1px);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .chat-message {
            margin-bottom: 1rem;
        }
        
        .chat-message.bot .flex {
            justify-content: flex-start;
        }
        
        .chat-message.user .flex {
            justify-content: flex-end;
        }
        
        .hidden {
            display: none !important;
        }
        
        .touch-spacing {
            margin-bottom: 1.5rem;
        }
        
        /* Review form theming: lighter field bg + forest card container */
        .nf-form-dark { background-color: var(--color-forest-card); color: var(--color-forest-light); }
        .nf-form-dark label { color: var(--color-forest-light); }
        .nf-form-dark input,
        .nf-form-dark textarea {
            background-color: var(--color-forest-light);
            color: var(--color-forest-text);
            border: 1px solid var(--color-forest-border);
        }
        .nf-form-dark input::placeholder,
        .nf-form-dark textarea::placeholder { color: var(--color-forest-text-muted); }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .main-content {
                padding: 2rem 0;
            }
            
            .container {
                padding: 0 0.5rem;
            }
        }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <header class="flex justify-between items-center mb-8">
            <a href="welcome.html" class="flex items-center space-x-3">
                <img src="images/logo.png" alt="Noctua Forest Logo" width="40" height="40" decoding="async" class="w-10 h-10">
                <span class="text-2xl font-bold" style="font-family: 'Poppins', sans-serif; color: #4A5450;">Noctua Forest</span>
            </a>
            <nav id="nav" class="hidden md:flex items-center space-x-8 text-lg ml-auto" style="font-family: 'Noto Sans', sans-serif;">
                <a href="forest.html" class="hover:text-forest-accent transition-colors duration-300 font-medium block md:inline-block py-3 md:py-0 px-4 md:px-0 text-left md:text-center" style="color:#3A4440">The Forest</a>
                <a href="reviews.html" class="hover:text-forest-accent transition-colors duration-300 font-medium block md:inline-block py-3 md:py-0 px-4 md:px-0 text-left md:text-center" style="color:#3A4440">Write a Review</a>
                <a href="help.html" class="hover:text-forest-accent transition-colors duration-300 font-medium block md:inline-block py-3 md:py-0 px-4 md:px-0 text-left md:text-center" style="color:#3A4440">Help</a>
                <a href="about.html" class="hover:text-forest-accent transition-colors duration-300 font-medium block md:inline-block py-3 md:py-0 px-4 md:px-0 text-left md:text-center" style="color:#3A4440">About</a>
            </nav>
            <div class="flex items-center gap-6">
                <button class="md:hidden" onclick="toggleMobileMenu()" aria-label="Toggle menu">
                    <svg class="w-6 h-6" fill="none" stroke="#4A5450" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
                <a href="account.html" class="hover:text-forest-accent transition-colors duration-300" aria-label="Account">
                    <svg class="w-6 h-6" fill="none" stroke="#4A5450" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                </a>
            </div>
        </header>
    </div>
    
    <!-- Page Header -->
    <div class="bg-gradient-to-r from-[#4A5450] to-[#3A4440] text-white py-12">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <h1 class="text-4xl font-bold mb-4">Share Your Review</h1>
            <p class="text-lg text-white/90">Help other readers discover great books through your authentic perspective</p>
        </div>
    </div>

    <!-- Main Content -->
    <main class="py-12">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="max-w-2xl mx-auto">
                <div class="nf-form-dark rounded-xl shadow-lg p-8">
                    <form id="reviewForm" class="space-y-8">
                        <!-- Book Information -->
                        <section class="space-y-4">
                            <h2 class="text-2xl font-bold text-white">Book Information</h2>
                            <div>
                                <label for="amazonUrl" class="block text-sm font-medium text-white mb-2">Amazon URL (optional - auto‑fills)</label>
                                <input id="amazonUrl" name="amazonUrl" type="url" placeholder="https://www.amazon.com/dp/…" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-forest-accent focus:border-forest-accent">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="title" class="block text-sm font-medium text-white mb-2">Book Title *</label>
                                    <input id="title" name="title" type="text" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-forest-accent focus:border-forest-accent">
            </div>
                                <div>
                                    <label for="author" class="block text-sm font-medium text-white mb-2">Author *</label>
                                    <input id="author" name="author" type="text" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-forest-accent focus:border-forest-accent">
                        </div>
                    </div>
                            
                        </section>

                        <!-- Review Content -->
                        <section class="space-y-4">
                            <h2 class="text-2xl font-bold text-white">Your Review</h2>
                            <div>
                                <label for="motivation" class="block text-sm font-medium text-white mb-2">What drew you to this book? *</label>
                                <input id="motivation" name="motivation" type="text" required placeholder="e.g., friend recommendation, love the author, needed escapism…" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-forest-accent focus:border-forest-accent">
                            </div>
                            <div>
                                <label for="review" class="block text-sm font-medium text-white mb-2">Your thoughts and feelings *</label>
                                <textarea id="review" name="review" rows="6" required placeholder="Share your honest thoughts about the book…" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-forest-accent focus:border-forest-accent"></textarea>
                </div>
                            <div>
                                <label class="block text-sm font-medium text-white mb-2">Moods & tags</label>
                                <div id="moodChips" class="flex flex-wrap gap-2 mb-2"></div>
                                <input id="moodInput" type="text" placeholder="Type a mood and press Enter…" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-forest-accent focus:border-forest-accent">
                                <p class="text-xs text-white/60 mt-1">Popular tags:</p>
                                <div id="suggestions" class="mt-2 flex flex-wrap gap-2 text-sm">
                                    <button type="button" class="px-2 py-1 rounded-full bg-forest-accent text-white" data-suggest="nostalgic">nostalgic</button>
                                    <button type="button" class="px-2 py-1 rounded-full bg-forest-accent text-white" data-suggest="dreamy">dreamy</button>
                                    <button type="button" class="px-2 py-1 rounded-full bg-forest-accent text-white" data-suggest="heartwarming">heartwarming</button>
                                    <button type="button" class="px-2 py-1 rounded-full bg-forest-accent text-white" data-suggest="intense">intense</button>
                                    <button type="button" class="px-2 py-1 rounded-full bg-forest-accent text-white" data-suggest="identity">identity</button>
                                    <button type="button" class="px-2 py-1 rounded-full bg-forest-accent text-white" data-suggest="family">family</button>
                                    <button type="button" class="px-2 py-1 rounded-full bg-forest-accent text-white" data-suggest="friendship">friendship</button>
                                    <button type="button" class="px-2 py-1 rounded-full bg-forest-accent text-white" data-suggest="romantic">romantic</button>
                                    <button type="button" class="px-2 py-1 rounded-full bg-forest-accent text-white" data-suggest="mystery">mystery</button>
                                    <button type="button" class="px-2 py-1 rounded-full bg-forest-accent text-white" data-suggest="adventure">adventure</button>
                                    <button type="button" class="px-2 py-1 rounded-full bg-forest-accent text-white" data-suggest="emotional">emotional</button>
                                    <button type="button" class="px-2 py-1 rounded-full bg-forest-accent text-white" data-suggest="inspiring">inspiring</button>
                                    <button type="button" class="px-2 py-1 rounded-full bg-forest-accent text-white" data-suggest="cozy">cozy</button>
                                    <button type="button" class="px-2 py-1 rounded-full bg-forest-accent text-white" data-suggest="dark">dark</button>
                                    <button type="button" class="px-2 py-1 rounded-full bg-forest-accent text-white" data-suggest="funny">funny</button>
                                    <button type="button" class="px-2 py-1 rounded-full bg-forest-accent text-white" data-suggest="thoughtful">thoughtful</button>
                                    <button type="button" class="px-2 py-1 rounded-full bg-forest-accent text-white" data-suggest="suspenseful">suspenseful</button>
                                    <button type="button" class="px-2 py-1 rounded-full bg-forest-accent text-white" data-suggest="hopeful">hopeful</button>
                                    <button type="button" class="px-2 py-1 rounded-full bg-forest-accent text-white" data-suggest="melancholy">melancholy</button>
                                    <button type="button" class="px-2 py-1 rounded-full bg-forest-accent text-white" data-suggest="uplifting">uplifting</button>
                    </div>
                </div>
                            <div>
                                <label for="audience" class="block text-sm font-medium text-white mb-2">Who would connect with this book? *</label>
                                <input id="audience" name="audience" type="text" required placeholder="e.g., teens figuring things out, anyone missing home, people going through change…" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-forest-accent focus:border-forest-accent">
                </div>
                            <div>
                                <label for="warnings" class="block text-sm font-medium text-white mb-2">Content warnings (optional)</label>
                                <input id="warnings" name="warnings" type="text" placeholder="e.g., violence, difficult themes…" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-forest-accent focus:border-forest-accent">
                            </div>
                            <div>
                                <label for="copyFormat" class="block text-sm font-medium text-white mb-2">How did you read it?</label>
                                <select id="copyFormat" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-forest-accent focus:border-forest-accent">
                                    <option value="">Select format (optional)</option>
                                    <option value="print">Printed copy</option>
                                    <option value="ebook">E‑book</option>
                                    <option value="audiobook">Audiobook</option>
                                </select>
                                <p class="text-xs text-white/60 mt-1">Curator Plus members can create reading playlists and mood boards</p>
                            </div>
                        </section>

                        <div>
                            <button id="submitReview" type="submit" class="w-full bg-forest-accent hover:bg-forest-accent-hover text-white font-semibold py-4 px-6 rounded-lg transition-colors duration-300 text-lg">Publish Your Review</button>
                            <p class="text-sm text-white/80 mt-3 text-center">Your review will be published with an anonymized forest name to protect your privacy.</p>
                        </div>
                    </form>
                    </div>
                </div>
            </div>
    </main>

    <!-- Firebase Configuration -->
    <script type="module">
      import { app, db } from './firebase-config.js';
      import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js';
      
      const pageAuth = getAuth(app);
      
      // Make auth and db available globally
      window.auth = pageAuth;
      window.db = db;
      
      onAuthStateChanged(pageAuth, (user) => {
        console.log('Auth state changed:', user ? 'signed in' : 'signed out');
      });
    </script>

    <!-- Review Form Logic -->
    <script type="module">
      import { app, db } from './firebase-config.js';
      import { getAuth } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js';
      import { addDoc, collection, serverTimestamp, doc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';
      import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js';
      import { fetchBookMetadata, extractASIN } from './js/amazonService.js';
      import { generateRandomForestName } from './js/randomForestNameService.js';

      const formAuth = getAuth(app);

      const form = document.getElementById('reviewForm');
      const amazonUrlInput = document.getElementById('amazonUrl');
      const moodInput = document.getElementById('moodInput');
      const moodChips = document.getElementById('moodChips');
      let moodTags = [];

      function renderChips(){
        if (!moodChips) return;
        moodChips.innerHTML = '';
        moodTags.slice(0,12).forEach((t, idx) => {
          const chip = document.createElement('span');
          chip.className = 'px-2 py-1 rounded-full bg-forest-accent text-white text-xs flex items-center gap-2';
          chip.textContent = t;
          const x = document.createElement('button');
          x.type = 'button';
          x.className = 'text-white/70 hover:text-white';
          x.textContent = '×';
          x.onclick = () => { moodTags.splice(idx,1); renderChips(); };
          chip.appendChild(x);
          moodChips.appendChild(chip);
        });
      }

      moodInput?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter'){
          e.preventDefault();
          const v = (moodInput.value || '').trim().toLowerCase();
          if (!v) return;
          if (!moodTags.includes(v)) moodTags.push(v);
          moodInput.value = '';
          renderChips();
        }
      });

      document.querySelectorAll('[data-suggest]')?.forEach(btn => {
        btn.addEventListener('click', () => {
          const v = btn.getAttribute('data-suggest');
          if (v && !moodTags.includes(v)) { 
            moodTags.push(v); 
            renderChips(); 
            btn.style.display = 'none'; // Hide suggestion after use
          }
        });
      });

      amazonUrlInput?.addEventListener('change', async (e) => {
        const url = e.target.value.trim();
        if (!url) return;
        try {
          const data = await fetchBookMetadata(url);
          document.getElementById('title').value = data.title || '';
          document.getElementById('author').value = data.author || '';
          const blurb = document.getElementById('blurb');
          if (blurb && !blurb.value) blurb.value = data.description || '';
        } catch (err) {
          console.warn('Amazon metadata fetch failed:', err);
        }
      });

      form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const user = formAuth.currentUser;
        if (!user) { alert('Please sign in to publish your review.'); return; }

        const title = document.getElementById('title').value.trim();
        const author = document.getElementById('author').value.trim();
        const blurbEl = document.getElementById('blurb');
        const blurb = blurbEl ? blurbEl.value.trim() : '';
        const motivation = document.getElementById('motivation').value.trim();
        const review = document.getElementById('review').value.trim();
        const audience = document.getElementById('audience').value.trim();
        const warnings = document.getElementById('warnings').value.trim();
        const amazonUrl = document.getElementById('amazonUrl').value.trim();
        const copyFormatEl = document.getElementById('copyFormat');
        const copyFormat = copyFormatEl ? copyFormatEl.value : '';

        if (!title || !author || !review || !motivation || !audience) { alert('Please complete required fields.'); return; }
        
        // Tag guidance
        if (moodTags.length < 3) {
          const proceed = confirm(`You've added ${moodTags.length} tags. We recommend 3-5 tags to help others discover your review. Continue anyway?`);
          if (!proceed) return;
        }

            const bookPayload = {
          title,
          author,
          primaryLanguage: 'en',
          authorRegion: 'Unknown',
          publicationYear: new Date().getFullYear(),
              publishedAt: new Date(),
              views: 0,
              popularity: 0,
          userId: user.uid,
          ownerId: user.uid,
          createdBy: user.uid,
            };

            const reviewPayload = {
          bookId: '',
          text: review,
          authorId: user.uid,
          authorAvatarUrl: user.photoURL || '',
          userId: user.uid,
          motivation,
          audience,
          contentWarnings: warnings ? warnings.split(',').map(s=>s.trim()).filter(Boolean) : [],
          moods: moodTags,
          copyFormat,
              hasReadBook: true,
              authenticReview: true,
          noAI: true,
        };

        const submitBtn = document.getElementById('submitReview');
        const original = submitBtn.textContent;
        submitBtn.textContent = 'Publishing…';
        submitBtn.disabled = true;

        try {
          let bookIdCreated = null;
          try {
            const bookRef = await addDoc(collection(db, 'books'), {
              ...bookPayload,
              description: blurb,
              reviewCount: 1,
              createdAt: serverTimestamp(),
              asin: amazonUrl ? extractASIN(amazonUrl) : '',
            });
            bookIdCreated = bookRef.id;

            // Attempt to resolve and persist a cover image into Firebase Storage
            try {
              // Fetch metadata (includes imageUrl if available)
              let metadata = null;
              if (amazonUrl) {
                try { metadata = await fetchBookMetadata(amazonUrl); } catch (_) { metadata = null; }
              }
              const candidateUrl = (metadata && metadata.coverUrl) ? String(metadata.coverUrl).trim() : '';

              if (candidateUrl) {
                const storage = getStorage(app);
                const imgRes = await fetch(candidateUrl, { mode: 'cors' });
                if (imgRes.ok) {
                  const blob = await imgRes.blob();
                  const path = `covers/${bookRef.id}.jpg`;
                  const ref = storageRef(storage, path);
                  await uploadBytes(ref, blob, { contentType: blob.type || 'image/jpeg' });
                  const downloadURL = await getDownloadURL(ref);
                  await updateDoc(doc(db, 'books', bookRef.id), { coverUrl: downloadURL });
                } else {
                  // As a fallback, persist the candidate URL directly so Forest can render it
                  await updateDoc(doc(db, 'books', bookRef.id), { coverUrl: candidateUrl.replace(/^http:\/\//, 'https://') });
                }
              }
            } catch (coverErr) {
              console.warn('[reviews] cover upload skipped:', coverErr);
            }
          } catch (bookErr) {
            console.warn('[reviews] books write denied; queueing submission', bookErr);
            await addDoc(collection(db, 'submissions'), {
              type: 'book',
              status: 'pending',
              payload: { ...bookPayload, description: blurb, asin: amazonUrl ? extractASIN(amazonUrl) : '' },
              createdAt: serverTimestamp(),
              userId: user.uid,
            });
          }

          if (bookIdCreated) {
            try {
              const reviewDoc = {
                ...reviewPayload,
                bookId: bookIdCreated,
                authorForestName: generateRandomForestName(),
                createdAt: serverTimestamp(),
              };
              await addDoc(collection(db, 'reviews'), reviewDoc);
            } catch (revErr) {
              console.warn('[reviews] reviews write denied; queueing submission', revErr);
              await addDoc(collection(db, 'submissions'), {
                type: 'review',
                status: 'pending',
                payload: { ...reviewPayload, bookId: bookIdCreated },
                createdAt: serverTimestamp(),
                userId: user.uid,
              });
            }
          } else {
            // If book write failed, queue the review with missing bookId; admin auto-promotion will create book first
            await addDoc(collection(db, 'submissions'), {
              type: 'review',
              status: 'pending',
              payload: { ...reviewPayload, bookId: null },
              createdAt: serverTimestamp(),
              userId: user.uid,
            });
          }

          if (bookIdCreated) {
            window.location.href = `book.html?id=${bookIdCreated}`;
          } else {
            alert('Thanks! Your review has been queued for publishing.');
          }
        } catch (err) {
          console.error('Review submit failed (unhandled):', err);
          alert('There was an error publishing your review. Please try again.');
        } finally {
          submitBtn.textContent = original;
          submitBtn.disabled = false;
        }
      });
    </script>

    <!-- Global Footer with Google Translate -->
    <script src="assets/footer.js"></script>
    
    <!-- Mobile Navigation Overlay -->
    <div id="navOverlay" class="nav-overlay"></div>
    
    <!-- Mobile Navigation Script -->
    <script src="assets/nav.js"></script>
  </body>
</html>
