<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Curator Landing Page — Noctua Forest</title>
    <meta name="description" content="Discover books curated by our Night Owl community">
    <link rel="stylesheet" href="assets/tailwind.css">
    <link rel="stylesheet" href="assets/base-styles.css">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;700&family=Noto+Serif:wght@400;600;700&family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-[#fbebcc]">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <a href="welcome.html" class="flex items-center space-x-3">
                <img src="images/logo.png" alt="Noctua Forest Logo" width="40" height="40" decoding="async" class="w-10 h-10">
                <span class="text-2xl font-bold" style="font-family: 'Poppins', sans-serif; color: #4A5450;">Noctua Forest</span>
            </a>
            <nav class="flex items-center space-x-6">
                <a href="forest.html" class="text-[#4A5450] hover:text-forest-accent transition-colors">The Forest</a>
                <a href="reviews.html" class="text-[#4A5450] hover:text-forest-accent transition-colors">Write a Review</a>
                <a href="about.html" class="text-[#4A5450] hover:text-forest-accent transition-colors">About</a>
            </nav>
        </header>

        <!-- Loading State -->
        <div id="loading" class="text-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-forest-accent border-t-transparent mx-auto mb-4"></div>
            <p class="text-lg text-[#4A5450]">Loading curator page...</p>
        </div>

        <!-- Curator Content -->
        <div id="curatorContent" class="hidden">
            <!-- Hero Section -->
            <section id="heroSection" class="bg-forest-card rounded-xl p-8 mb-8 text-white">
                <div class="text-center">
                    <h1 id="heroTitle" class="text-4xl font-bold mb-4" style="font-family: 'Poppins', sans-serif;">Welcome to my curated collection</h1>
                    <p id="heroSubtitle" class="text-xl text-white/80">Discover books I love and recommend</p>
                </div>
            </section>

            <!-- About Section -->
            <section id="aboutSection" class="bg-white rounded-xl p-8 mb-8">
                <h2 id="aboutTitle" class="text-2xl font-semibold mb-4 text-[#4A5450]">About <span id="curatorName">Your Name</span></h2>
                <p id="curatorBio" class="text-[#4A5450] leading-relaxed">Passionate reader and curator</p>
            </section>

            <!-- Featured Lists -->
            <section id="featuredLists" class="mb-8">
                <h2 class="text-2xl font-semibold mb-6 text-[#4A5450]">Featured Lists</h2>
                <div id="listsGrid" class="grid md:grid-cols-3 gap-6">
                    <!-- Lists will be populated here -->
                </div>
            </section>

            <!-- Private: Recent Attributions (no public counts) -->
            <section id="attributionsSection" class="mb-8 hidden">
                <h2 class="text-2xl font-semibold mb-6 text-[#4A5450]">Recent Saves From Your Lists</h2>
                <div id="attributionsList" class="bg-white rounded-xl p-6 divide-y divide-gray-200"></div>
            </section>

            <!-- Social Links -->
            <section id="socialSection" class="bg-white rounded-xl p-8 mb-8">
                <h2 class="text-2xl font-semibold mb-4 text-[#4A5450]">Connect</h2>
                <div id="socialLinks" class="flex flex-wrap gap-4">
                    <!-- Social links will be populated here -->
                </div>
            </section>

            <!-- CTA Section -->
            <section class="bg-forest-card rounded-xl p-8 text-white text-center">
                <h2 class="text-2xl font-semibold mb-4">Explore The Forest</h2>
                <p class="text-white/80 mb-6">Discover more books and join our community of Night Owls</p>
                <a href="forest.html" class="inline-block px-8 py-3 bg-forest-accent hover:bg-[#E0751C] text-white font-semibold rounded-lg transition duration-300">
                    Browse All Books
                </a>
            </section>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden text-center py-16">
            <div class="max-w-md mx-auto">
                <svg class="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                </svg>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Curator not found</h3>
                <p class="text-gray-600 mb-6">This curator page doesn't exist or has been removed.</p>
                <a href="forest.html" class="inline-block bg-forest-accent hover:bg-forest-accent-hover text-white font-semibold py-3 px-6 rounded-full transition-all duration-300">
                    Explore The Forest
                </a>
            </div>
        </div>
    </div>

    <script type="module">
        import { doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js';
        import { db } from './firebase-config.js';
        import { getSharedList, getAttributionsForCurator } from './js/readingListService.js';

        // Get curator ID from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const curatorId = urlParams.get('id');

        if (!curatorId) {
            showError();
            return;
        }

        // Load curator landing page data
        loadCuratorPage(curatorId);

        async function loadCuratorPage(curatorId) {
            try {
                // Get curator landing page data
                const landingDoc = await getDoc(doc(db, 'curatorLandingPages', curatorId));
                
                if (!landingDoc.exists()) {
                    showError();
                    return;
                }

                const landingData = landingDoc.data();
                
                // Update page title
                document.getElementById('pageTitle').textContent = `${landingData.curatorName || 'Curator'} — Noctua Forest`;
                
                // Update hero section
                document.getElementById('heroTitle').textContent = landingData.heroTitle || 'Welcome to my curated collection';
                document.getElementById('heroSubtitle').textContent = landingData.heroSubtitle || 'Discover books I love and recommend';
                
                // Apply custom colors
                if (landingData.colors) {
                    const heroSection = document.getElementById('heroSection');
                    heroSection.style.backgroundColor = landingData.colors.accent || '#3A4440';
                    
                    const heroTitle = document.getElementById('heroTitle');
                    heroTitle.style.color = landingData.colors.primary || '#F58220';
                }
                
                // Update about section
                document.getElementById('curatorName').textContent = landingData.curatorName || 'Your Name';
                document.getElementById('curatorBio').textContent = landingData.curatorBio || 'Passionate reader and curator';
                
                // Load featured lists
                if (landingData.featuredLists && landingData.featuredLists.length > 0) {
                    await loadFeaturedLists(landingData.featuredLists);
                } else {
                    document.getElementById('featuredLists').style.display = 'none';
                }
                
                // Load social links
                if (landingData.socialLinks) {
                    loadSocialLinks(landingData.socialLinks);
                } else {
                    document.getElementById('socialSection').style.display = 'none';
                }
                
                // Private attributions (only if viewing own page)
                try {
                    const auth = getAuth();
                    const currentUid = auth.currentUser?.uid;
                    if (currentUid && currentUid === curatorId) {
                        const atts = await getAttributionsForCurator(curatorId, 25);
                        const section = document.getElementById('attributionsSection');
                        const listEl = document.getElementById('attributionsList');
                        if (atts.length > 0) {
                            section.classList.remove('hidden');
                            listEl.innerHTML = atts.map(a => `
                              <div class="py-3 flex items-center justify-between">
                                <div class="text-[#4A5450]">
                                  <div class="font-medium">Book saved from your list</div>
                                  <div class="text-sm opacity-80">Book: ${a.bookId} · Saved by: ${a.saverId}</div>
                                </div>
                                <a href="list.html?id=${a.sourceListId}" class="text-forest-accent hover:underline text-sm">View list</a>
                              </div>
                            `).join('');
                        }
                    }
                } catch (e) {
                    console.warn('Attributions not shown:', e);
                }

                // Show content
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('curatorContent').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading curator page:', error);
                showError();
            }
        }

        async function loadFeaturedLists(listIds) {
            const listsGrid = document.getElementById('listsGrid');
            listsGrid.innerHTML = '';
            
            for (const listId of listIds) {
                try {
                    const list = await getSharedList(listId);
                    if (list) {
                        const listCard = document.createElement('div');
                        listCard.className = 'bg-white rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow';
                        
                        // Create book cover collage
                        const coverHtml = list.books && list.books.length > 0 
                            ? `<div class="grid grid-cols-2 gap-2 mb-4 aspect-[4/3]">
                                ${list.books.slice(0, 4).map(book => `
                                    <img src="${book.coverUrl || 'images/placeholder.jpg'}" 
                                        alt="${book.title}" 
                                        class="w-full h-full object-cover rounded-lg"
                                        loading="lazy">
                                `).join('')}
                               </div>`
                            : `<div class="bg-gray-100 rounded-lg mb-4 aspect-[4/3] flex items-center justify-center">
                                <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                               </div>`;
                        
                        listCard.innerHTML = `
                            ${coverHtml}
                            <h3 class="font-semibold text-[#4A5450] mb-2">${list.name}</h3>
                            <p class="text-sm text-gray-600 mb-3">${list.books?.length || 0} books</p>
                            <a href="list.html?id=${listId}" class="inline-block w-full text-center px-4 py-2 bg-forest-accent text-white rounded-lg hover:bg-[#E0751C] transition duration-300">
                                View List
                            </a>
                        `;
                        
                        listsGrid.appendChild(listCard);
                    }
                } catch (error) {
                    console.error('Error loading list:', listId, error);
                }
            }
        }

        function loadSocialLinks(socialLinks) {
            const socialContainer = document.getElementById('socialLinks');
            socialContainer.innerHTML = '';
            
            const socialPlatforms = [
                { key: 'website', name: 'Website', icon: '🌐' },
                { key: 'twitter', name: 'Twitter/X', icon: '🐦' },
                { key: 'instagram', name: 'Instagram', icon: '📷' },
                { key: 'medium', name: 'Medium', icon: '📝' },
                { key: 'youtube', name: 'YouTube', icon: '📺' }
            ];
            
            socialPlatforms.forEach(platform => {
                if (socialLinks[platform.key]) {
                    const link = document.createElement('a');
                    link.href = socialLinks[platform.key];
                    link.target = '_blank';
                    link.rel = 'noopener noreferrer';
                    link.className = 'flex items-center space-x-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors';
                    link.innerHTML = `
                        <span>${platform.icon}</span>
                        <span class="text-[#4A5450]">${platform.name}</span>
                    `;
                    socialContainer.appendChild(link);
                }
            });
        }

        function showError() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
        }
    </script>
</body>
</html>
