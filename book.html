<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="format-detection" content="telephone=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Noctua Forest">
  <meta name="theme-color" content="#4A5450">
  <title>Book — Noctua Forest</title>
  <meta name="description" content="Discover authentic reader reviews and book recommendations on Noctua Forest. Join our Night Owl community for curated book discovery.">
  <meta property="og:title" content="Book — Noctua Forest">
  <meta property="og:description" content="Discover authentic reader reviews and book recommendations on Noctua Forest.">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">
  <link rel="canonical" href="https://noctuaforest.com/book.html">
  <link rel="preload" href="assets/tailwind.css" as="style">
  <link rel="stylesheet" href="assets/tailwind.css">
  <link rel="preload" href="assets/base-styles.css" as="style">
  <link rel="stylesheet" href="assets/base-styles.css">
  <link rel="stylesheet" href="assets/nav.css">
  <link rel="stylesheet" href="assets/base-styles.css">
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="icon" type="image/png" sizes="72x72" href="favicon.png">
  <link rel="icon" type="image/png" sizes="70x70" href="favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;700&family=Noto+Serif:wght@400;600;700&family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
  
  <!-- Google tag (gtag.js) with Consent Management -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-0ZWN1Z3DYQ" onerror="console.warn('Google Analytics failed to load')"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    
    // Set default consent mode
    gtag('consent', 'default', {
      'analytics_storage': 'denied'
    });
    
    gtag('config', 'G-0ZWN1Z3DYQ', {
      'anonymize_ip': true
    });
  </script>
  
  <!-- Cookie Consent Management -->
  <script src="assets/cookie-consent.js"></script>
  
  <!-- Global Footer with Google Translate -->
  <script defer src="assets/footer.js"></script>
  
  <!-- Book Schema Markup (will be populated by JavaScript) -->
  <script type="application/ld+json" id="bookSchema">
  {
    "@context": "https://schema.org",
    "@type": "Book",
    "name": "",
    "author": {
      "@type": "Person",
      "name": ""
    },
    "description": "",
    "datePublished": "",
    "inLanguage": "",
    "publisher": {
      "@type": "Organization", 
      "name": "Noctua Forest"
    },
    "offers": {
      "@type": "Offer",
      "availability": "https://schema.org/InStock",
      "url": ""
    }
  }
  </script>
  
  <!-- Safari Compatibility Script -->
  <script>
    // Safari detection
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    
    if (isSafari || isIOS) {
      document.documentElement.classList.add('safari');
      if (isIOS) document.documentElement.classList.add('ios');
    }
    
    // Safari touch event handling
    document.addEventListener('touchstart', function(){}, {passive: true});
  </script>
  
  <style>
    body { font-family: 'Noto Sans', sans-serif; background-color: #fbebcc; }
    
    /* Safari-specific loading state */
    .safari .loading-img {
      position: relative;
      min-height: 200px;
      background: linear-gradient(110deg, #ececec 8%, #f5f5f5 18%, #ececec 33%);
      background-size: 200% 100%;
      animation: 1.5s shine linear infinite;
    }
    
    @keyframes shine {
      to { background-position-x: -200%; }
    }
    
    /* Safari-specific button styles */
    .safari button {
      -webkit-tap-highlight-color: transparent;
    }
    
    /* iOS-specific viewport height fix */
    .ios .full-height {
      height: -webkit-fill-available;
    }

    /* Report button styles */
    .report-button {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      background-color: #3A4440;
      color: #E0E2DB80;
      transition: all 0.2s;
    }

    .report-button:hover {
      background-color: #4A5450;
      color: #E0E2DB;
    }
  </style>
</head>
<body>
  <!-- Skip Links -->
  <div class="skip-links" role="navigation" aria-label="Skip links">
    <a href="#nav" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-forest-accent text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-forest-accent z-50">Skip to navigation</a>
    <a href="#main" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-forest-accent text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-forest-accent z-50">Skip to main content</a>
  </div>

  <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <header class="flex justify-between items-center mb-8">
      <a href="welcome.html" class="flex items-center space-x-3 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-forest-accent" aria-label="Return to Noctua Forest home page">
        <img src="images/logo.png" alt="Noctua Forest Logo" width="40" height="40" decoding="async" class="w-10 h-10">
        <span class="text-2xl font-bold text-[#3A4440]" style="font-family: 'Poppins', sans-serif;">Noctua Forest</span>
      </a>
      <nav id="nav" class="hidden md:flex items-center space-x-8 text-lg ml-auto" role="navigation" aria-label="Main navigation" style="font-family: 'Noto Sans', sans-serif;">
        <a href="forest.html" class="hover:text-forest-accent transition-colors duration-300 font-medium block md:inline-block py-3 md:py-0 px-4 md:px-0 text-left md:text-center" style="color:#3A4440">The Forest</a>
        <a href="reviews.html" class="hover:text-forest-accent transition-colors duration-300 font-medium block md:inline-block py-3 md:py-0 px-4 md:px-0 text-left md:text-center" style="color:#3A4440">Write a Review</a>
        <a href="help.html" class="hover:text-forest-accent transition-colors duration-300 font-medium block md:inline-block py-3 md:py-0 px-4 md:px-0 text-left md:text-center" style="color:#3A4440">Help</a>
        <a href="about.html" class="hover:text-forest-accent transition-colors duration-300 font-medium block md:inline-block py-3 md:py-0 px-4 md:px-0 text-left md:text-center" style="color:#3A4440">About</a>
      </nav>
      <div class="flex items-center gap-2">
        <button class="md:hidden" onclick="toggleMobileMenu()" aria-label="Toggle menu">
          <svg class="w-6 h-6" fill="none" stroke="#4A5450" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
        </button>
        <a href="account.html" class="hover:text-forest-accent transition-colors duration-300" aria-label="Account">
          <svg class="w-6 h-6" fill="none" stroke="#4A5450" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
        </a>
      </div>
    </header>

    <!-- Breadcrumb Navigation -->
    <nav class="max-w-5xl mx-auto px-4 mb-6" aria-label="Breadcrumb">
      <ol class="breadcrumb flex items-center space-x-2 text-sm">
        <li><a href="welcome.html" class="hover:text-forest-accent transition-colors">Home</a></li>
        <li><span class="mx-2">/</span></li>
        <li><a href="forest.html" class="hover:text-forest-accent transition-colors">The Forest</a></li>
        <li><span class="mx-2">/</span></li>
        <li id="breadcrumbBookTitle" class="breadcrumb-current" aria-current="page">Book Details</li>
      </ol>
    </nav>

    <!-- Breadcrumb Structured Data -->
    <script type="application/ld+json" id="breadcrumbSchema">
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Home",
          "item": "https://noctuaforest.com/"
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": "The Forest",
          "item": "https://noctuaforest.com/forest.html"
        },
        {
          "@type": "ListItem",
          "position": 3,
          "name": "Book Details",
          "item": "https://noctuaforest.com/book.html"
        }
      ]
    }
    </script>

    <main id="main" class="max-w-5xl mx-auto" role="main">
      <div id="loading" class="text-center text-[#3A4440]" role="status" aria-live="polite">Loading…</div>
      <article id="bookView" class="hidden bg-forest-card text-white rounded-xl shadow-sm p-6 md:p-10" aria-labelledby="title">
        <div class="grid md:grid-cols-2 gap-8">
          <div>
            <img 
              id="coverImg" 
              class="w-full rounded-lg shadow loading-img" 
              alt="Book cover" 
              role="img" 
              aria-labelledby="title"
              decoding="async"
              fetchpriority="high" />
          </div>
          <div>
            <h1 id="title" class="text-3xl font-bold mb-2 text-white" style="font-family: 'Poppins', sans-serif;"></h1>
            <div class="flex items-center gap-2 mb-4">
              <p id="author" class="text-lg text-white/90"></p>

            </div>
            
            <!-- Reader Insights Section -->
            <div id="reviewInsights" class="mb-6">
              <!-- Insights will be loaded dynamically -->
            </div>

            <div class="space-y-2 text-sm text-white/80 mb-6" role="list" aria-label="Book details">
              <div role="listitem"><span class="font-semibold text-white">Language:</span> <span id="primaryLanguage"></span></div>
              <div role="listitem"><span class="font-semibold text-white">Region:</span> <span id="authorRegion"></span></div>
              <div role="listitem"><span class="font-semibold text-white">Published:</span> <span id="publicationYear"></span></div>
              
            </div>

            <div class="flex flex-wrap gap-3">
              <a 
                id="purchaseLink" 
                href="#" 
                target="_blank" 
                class="px-5 py-2 bg-forest-accent text-white rounded-full hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-white/20 transition-colors duration-300"
                aria-label="Buy or learn more about this book">
                Buy or Learn More
              </a>
              <a 
                id="purchaseLink2" 
                href="#" 
                target="_blank" 
                class="hidden px-5 py-2 bg-[#5A6560] text-white rounded-full hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-white/20 transition-colors duration-300"
                aria-label="Alternative purchase link">
                Alternate Link
              </a>
              <div class="relative">
                <button 
                  id="addToList" 
                  class="px-5 py-2 bg-forest-secondary text-white rounded-full hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-white/20 transition-colors duration-300 flex items-center"
                  aria-label="Add book to list">
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                  </svg>
                  Add to List
                </button>

                <!-- List Selection Dropdown -->
                <div id="listDropdown" class="hidden absolute left-0 right-0 mt-2 bg-forest-card rounded-xl shadow-lg overflow-hidden z-10">
                  <div class="p-4 border-b border-white/10">
                    <h3 class="font-medium text-white mb-2">Add to List</h3>
                    <button id="createNewList" class="w-full text-left px-3 py-2 text-forest-accent hover:bg-[#3A4440] rounded-lg transition-colors duration-200 flex items-center">
                      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                      </svg>
                      Create New List
                    </button>
                  </div>
                  <div class="max-h-64 overflow-y-auto py-2" id="listOptions">
                    <!-- Lists will be populated here -->
                    <div class="px-4 py-2 text-white/60 italic text-sm text-center">No lists yet</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Book Moods (moved here) -->
            <div class="mt-6">
              <h3 class="text-lg font-semibold mb-3 text-white">Book Moods</h3>
              <div id="wordCloud" class="min-h-[88px] text-white/90"></div>
              <p id="copyFormatSummary" class="mt-3 text-white/80 text-sm"></p>
            </div>

            <p id="actionMsg" class="mt-4 text-green-600 hidden" role="status" aria-live="polite">Added to your reading list.</p>
            <p id="curatorAttribution" class="mt-4 text-sm text-white/70 hidden" role="status"></p>
            <p id="memberAttribution" class="mt-2 text-sm text-white/70 hidden" role="status">
              <a href="https://buy.stripe.com/6oU9ATfwO5mJ9PY9tQaVa02" class="text-forest-accent hover:underline">Join Noctua Forest</a> to create your own curated lists.
            </p>
          </div>
        </div>

        <!-- Reader Reviews Section -->
        <div class="mt-12 border-t border-white/20 pt-8">
          <h2 class="text-2xl font-bold mb-2 text-white" style="font-family: 'Poppins', sans-serif;">Reader Reviews</h2>
          <p class="text-white/70 mb-6">You’ve reached a clearing. Settle in and see what other Night Owls felt while reading this book.</p>
          
          <!-- At-a-Glance Summary (warnings only) -->
          <section id="reviewSummary" class="mb-8 bg-[#3A4440] rounded-lg p-6">
            <h3 class="text-lg font-semibold mb-3 text-white">Content Warnings</h3>
            <div id="warningsSpoiler" class="text-sm">
              <button id="toggleWarnings" class="px-3 py-1 rounded-full bg-[#4A5450] text-white hover:bg-[#5A6560] transition">Show warnings</button>
              <div id="warningsList" class="mt-3 hidden"></div>
            </div>
          </section>
          
          <!-- Review Controls -->
          <div class="flex items-center justify-between mb-4">
            <div class="text-white/80 text-sm">Sort by</div>
            <select id="reviewSort" class="bg-[#3A4440] text-white rounded-lg px-3 py-2 border border-white/10">
              <option value="newest">Newest</option>
            </select>
          </div>
          
          <!-- Review List -->
          <div id="reviewList" class="grid md:grid-cols-2 gap-6 mb-8">
            <!-- Reviews will be loaded here -->
          </div>

          <!-- Empty State -->
          <div id="reviewsEmpty" class="hidden text-center py-12 bg-[#3A4440] rounded-lg">
            <div class="mb-4">
              <svg class="w-12 h-12 mx-auto text-white/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
              </svg>
            </div>
            <h3 class="text-xl font-semibold text-white mb-2">Be the first to share your thoughts!</h3>
            <p class="text-white/80 max-w-xl mx-auto mb-6">Your review helps other readers discover this book. Tag moods and themes, and warn about sensitive content.</p>
            <a href="reviews.html" class="inline-block px-6 py-3 bg-forest-accent text-white rounded-full hover:opacity-90">Write the First Review</a>
          </div>

          <!-- Bottom CTA (only when no reviews) -->
          <div id="bottomReviewCta" class="hidden text-center mt-8">
            <a href="reviews.html" class="inline-block px-6 py-3 bg-forest-accent text-white rounded-full hover:opacity-90">Add Your Review</a>
          </div>
          
          <!-- Similar Books -->
          <div class="mt-12 border-t border-white/20 pt-8 space-y-8">
            <!-- More from Author -->
            <div id="moreFromAuthor" class="hidden">
              <h2 class="text-2xl font-bold mb-6 text-white" style="font-family: 'Poppins', sans-serif;">More from this Author</h2>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-6 book-grid">
                <!-- Books will be loaded here -->
              </div>
            </div>

            <!-- Similar Books -->
            <div id="similarBooks" class="hidden">
              <h2 class="text-2xl font-bold mb-6 text-white" style="font-family: 'Poppins', sans-serif;">Similar Books</h2>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-6 book-grid">
                <!-- Books will be loaded here -->
              </div>
            </div>

            <!-- Frequently Listed Together -->
            <div id="listedTogether" class="hidden">
              <h2 class="text-2xl font-bold mb-6 text-white" style="font-family: 'Poppins', sans-serif;">Frequently Listed Together</h2>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-6 book-grid">
                <!-- Books will be loaded here -->
              </div>
            </div>
          </div>


          <!-- Sign in prompt -->
          <div id="signInPrompt" class="hidden text-center py-4">
            <p class="text-white/80 mb-4">Sign in to write a review</p>
            <a href="account.html" 
              class="inline-block px-5 py-2 bg-forest-accent text-white rounded-full hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-white/20 transition-colors duration-300">
              Sign In
            </a>
          </div>
        </div>
      </article>
    </main>
  </div>

  <!-- Review Policy Modal -->
  <div id="policyModal" class="hidden fixed inset-0 bg-black/60 items-center justify-center z-50">
    <div class="bg-white rounded-xl w-full max-w-md mx-4 p-6">
      <h3 class="text-xl font-bold mb-4 text-[#4A5450]">Review Policy</h3>
      <div class="prose prose-sm text-[#4A5450] mb-6">
        <p>Noctua Forest is built on authentic, personal reading experiences. We have a strict policy against AI-generated content:</p>
        <ul class="list-disc pl-5 space-y-2">
          <li class="text-red-600 font-medium">AI-generated reviews are strictly prohibited and will be removed</li>
          <li>Reviews must be based on your actual reading experience</li>
          <li>Share your genuine thoughts, feelings, and insights</li>
          <li>Focus on how the book affected you personally</li>
        </ul>
        <p class="mt-4">Additionally, we reserve the right to remove reviews that:</p>
        <ul class="list-disc pl-5 space-y-2">
          <li>Contain offensive or inappropriate language</li>
          <li>Are spam or promotional in nature</li>
          <li>Include personal attacks or harassment</li>
          <li>Violate copyright or intellectual property rights</li>
          <li>Are off-topic or irrelevant to the book discussion</li>
        </ul>
        <p class="mt-4">For more details, please review our <a href="content-policy.html" class="text-forest-accent hover:underline">Content Policy</a>.</p>
      </div>
      <button id="closePolicyModal" class="w-full px-4 py-2 bg-[#4A5450] text-white rounded-md hover:bg-[#3A4440]">
        I understand
      </button>
    </div>
  </div>

  <!-- List Modal -->
  <div id="listModal" class="hidden fixed inset-0 bg-black/60 items-center justify-center z-50">
    <div class="bg-forest-card rounded-xl w-full max-w-lg mx-4 p-6">
      <h3 class="text-xl font-bold mb-4 text-white">Create New List</h3>
      <form id="listForm" class="space-y-4">
        <div>
          <label for="listName" class="block text-sm font-medium text-white/90 mb-1">List Name</label>
          <input type="text" id="listName" required
            class="w-full px-4 py-2 rounded-lg bg-[#3A4440] border border-[#7A8580] text-white"
            placeholder="e.g., Wish List">
        </div>
        <div>
          <label for="listDescription" class="block text-sm font-medium text-white/90 mb-1">Description (Optional)</label>
          <textarea id="listDescription" rows="3"
            class="w-full px-4 py-2 rounded-lg bg-[#3A4440] border border-[#7A8580] text-white"
            placeholder="What's this list about?"></textarea>
        </div>
        <div class="flex justify-end gap-3">
          <button type="button" id="cancelList" class="px-4 py-2 bg-[#3A4440] text-white rounded-full hover:opacity-90">
            Cancel
          </button>
          <button type="submit" class="px-4 py-2 bg-forest-accent text-white rounded-full hover:opacity-90">
            Create & Add Book
          </button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { app, db } from './firebase-config.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js';
    import { doc, getDoc, addDoc, collection, serverTimestamp, query, where, orderBy, limit, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';
    import { createList, getUserLists, addBookToList, getList, getActiveListsCount } from './js/readingListService.js';
    import { getBookMoods, getContentWarnings, formatMoodName, formatWarningName, getMoodColor } from './js/reviewService.js';
    import { getCopyFormatStats } from './js/reviewService.js';
    import { validateReview, flagContent } from './js/moderationService.js';
    import { getSimilarBooks, getMoreFromAuthor, getFrequentlyListedTogether } from './js/recommendationService.js';
    import { reportReview } from './js/reportingService.js';
    import { trackBookClick } from './js/analyticsService.js';

    const auth = getAuth(app);

    function getParam(name){
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    // Persist referral code from URL
    const ref = getParam('ref');
    const src = getParam('src'); // source list id (optional)
    if (ref) {
        try {
            sessionStorage.setItem('nf_ref', ref);
        } catch (e) {
            console.warn('Could not persist referral code.', e);
        }
    }

    // Handle list management
    const addToListBtn = document.getElementById('addToList');
    const listDropdown = document.getElementById('listDropdown');
    const listOptions = document.getElementById('listOptions');
    const createNewListBtn = document.getElementById('createNewList');
    const listModal = document.getElementById('listModal');
    const listForm = document.getElementById('listForm');
    const cancelListBtn = document.getElementById('cancelList');
    let currentBook = null;
    let sourceListId = src || sessionStorage.getItem('nf_src') || null;
    if (src) { try { sessionStorage.setItem('nf_src', src); } catch (e) {} }

    // Track purchase clicks (attribution funnel)
    const purchaseLink = document.getElementById('purchaseLink');
    const purchaseLink2 = document.getElementById('purchaseLink2');
    function handlePurchaseClick(){
      try {
        const curator = ref || sessionStorage.getItem('nf_ref');
        if (curator) {
          trackBookClick(sourceListId || 'direct', (currentBook?.id || getParam('id')), curator, 'book');
        }
      } catch {}
    }
    purchaseLink?.addEventListener('click', handlePurchaseClick, { once: false });
    purchaseLink2?.addEventListener('click', handlePurchaseClick, { once: false });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
        if (!addToListBtn.contains(e.target) && !listDropdown.contains(e.target)) {
            listDropdown.classList.add('hidden');
        }
    });

    // Toggle dropdown
    addToListBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        
        if (!auth.currentUser) {
            window.location.href = 'account.html';
            return;
        }

        listDropdown.classList.toggle('hidden');
        
        // Load user's lists
        try {
            const lists = await getUserLists(auth.currentUser.uid);
            if (lists.length === 0) {
                listOptions.innerHTML = `
                    <div class="px-4 py-2 text-white/60 italic text-sm text-center">
                        No lists yet
                    </div>
                `;
                return;
            }

            listOptions.innerHTML = lists.map(list => `
                <button class="w-full text-left px-4 py-2 text-white hover:bg-[#3A4440] transition-colors duration-200 flex items-center justify-between group"
                        onclick="addToExistingList('${list.id}')">
                    <span>${list.name}</span>
                    <span class="text-white/60 text-sm group-hover:text-white/90">
                        ${list.books?.length || 0} books
                    </span>
                </button>
            `).join('');
        } catch (err) {
            console.error('Failed to load lists:', err);
            listOptions.innerHTML = `
                <div class="px-4 py-2 text-red-400 italic text-sm text-center">
                    Failed to load lists
                </div>
            `;
        }
    });

    // Create new list
    createNewListBtn.addEventListener('click', () => {
        listDropdown.classList.add('hidden');
        listForm.reset();
        listModal.classList.remove('hidden');
        listModal.classList.add('flex');
    });

    cancelListBtn.addEventListener('click', () => {
        listModal.classList.add('hidden');
        listModal.classList.remove('flex');
    });

    listForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('listName').value.trim();
        const description = document.getElementById('listDescription').value.trim();

        try {
            // Create list
            const listId = await createList(auth.currentUser.uid, name, description);
            
            // Add current book
            if (currentBook) {
                await addBookToList(listId, currentBook);
                const curator = ref || sessionStorage.getItem('nf_ref');
                if (sourceListId && curator && auth.currentUser) {
                  try { await recordAttribution(sourceListId, curator, currentBook.id, auth.currentUser.uid, listId); } catch {}
                }
                const msg = document.getElementById('actionMsg');
                msg.textContent = `Added to "${name}"`;
                msg.classList.remove('hidden');
                setTimeout(() => msg.classList.add('hidden'), 3000);
            }

            listModal.classList.add('hidden');
            listModal.classList.remove('flex');
        } catch (err) {
            console.error('Failed to create list:', err);
            alert('Failed to create list. Please try again.');
        }
    });

    // Add to existing list
    window.addToExistingList = async (listId) => {
        try {
            await addBookToList(listId, currentBook);
            const curator = ref || sessionStorage.getItem('nf_ref');
            if (sourceListId && curator && auth.currentUser) {
              try { await recordAttribution(sourceListId, curator, currentBook.id, auth.currentUser.uid, listId); } catch {}
            }
            const list = await getList(listId);
            const msg = document.getElementById('actionMsg');
            msg.textContent = `Added to "${list.name}"`;
            msg.classList.remove('hidden');
            setTimeout(() => msg.classList.add('hidden'), 3000);
            listDropdown.classList.add('hidden');
        } catch (err) {
            console.error('Failed to add to list:', err);
            if (err.message.includes('review this book')) {
              const confirmed = confirm('You need to review this book before adding it to a list. Would you like to write a review now?');
              if (confirmed) {
                window.location.href = 'reviews.html';
              }
            } else {
              alert('Failed to add book to list. Please try again.');
            }
        }
    };

    async function loadRecommendations(bookId, book) {
      try {
        // More from Author (exclude current)
        if (book.author) {
          const authorBooks = await getMoreFromAuthor(book.author, bookId);
          if (authorBooks.length > 0) {
            const container = document.getElementById('moreFromAuthor');
            const grid = container.querySelector('.book-grid');
            grid.innerHTML = '';
            authorBooks
              .filter(b => String(b.id) !== String(bookId))
              .forEach(b => grid.appendChild(renderBookCard(b)));
            container.classList.remove('hidden');
          }
        }

        // Similar Books (exclude current)
        const moods = book.moods || [];
        const genres = book.genres || [];
        const similarBooks = await getSimilarBooks(bookId, { moods, genres });
        if (similarBooks.length > 0) {
          const container = document.getElementById('similarBooks');
          const grid = container.querySelector('.book-grid');
          grid.innerHTML = '';
          similarBooks
            .filter(b => String(b.id) !== String(bookId))
            .forEach(b => grid.appendChild(renderBookCard(b)));
          container.classList.remove('hidden');
        }

        // Frequently Listed Together
        const listedBooks = await getFrequentlyListedTogether(bookId);
        if (listedBooks.length > 0) {
          const container = document.getElementById('listedTogether');
          const grid = container.querySelector('.book-grid');
          grid.innerHTML = '';
          listedBooks.forEach(book => {
            grid.appendChild(renderBookCard(book));
          });
          container.classList.remove('hidden');
        }
      } catch (err) {
        console.error('Error loading recommendations:', err);
      }
    }

    async function loadBook(){
      try {
        const id = getParam('id');
        if(!id){
          document.getElementById('loading').textContent = 'Missing book id.';
          return;
        }
        
        let b = null;
        
        try{
          // First try to get data from Firestore (for authenticated users)
          const snap = await getDoc(doc(db, 'books', id));
          if(snap.exists()){
            b = snap.data();
          }
        } catch(firestoreError) {
          console.log('Firestore not available or book missing, using fallback.', firestoreError);
        }
        
        // If Firestore failed or book not found, try public API
        if (!b) {
          try {
            const response = await fetch(`/api/books/${id}`);
            if (response.ok) {
              const apiData = await response.json();
              if (apiData.success && apiData.book) {
                b = apiData.book;
                console.log('Loaded book from public API');
              }
            }
          } catch(apiError) {
            console.error('Public API also failed:', apiError);
          }
        }
        
        // Removed sample fallback
        
        // If both methods failed
        if (!b) {
          document.getElementById('loading').textContent = 'Book not found.';
          return;
        }
        
        document.getElementById('loading').classList.add('hidden');
        const view = document.getElementById('bookView');
        view.classList.remove('hidden');
        
        // Safely update elements with null checks
        const updateElement = (id, content) => {
          const element = document.getElementById(id);
          if (element) element.textContent = content;
        };
        
        updateElement('title', b.title || 'Untitled');
        updateElement('author', b.author ? `by ${b.author}` : '');
        updateElement('breadcrumbBookTitle', b.title || 'Book Details');
        // Description intentionally not displayed
        updateElement('primaryLanguage', b.primaryLanguage || '');
        updateElement('authorRegion', b.authorRegion || '');
        updateElement('publicationYear', b.publicationYear || '');


        
        // Handle cover image with PA API integration (no storage beyond 24h; we only use returned URL)
        const cover = document.getElementById('coverImg');
        if(cover) {
          cover.classList.add('loading-img');
          let coverUrl = null;
          let amazonHref = null;

          // Try PA API first if ASIN available
          if (b.asin) {
            try {
              const paResponse = await fetch(`/api/pa/items?asin=${encodeURIComponent(b.asin)}`);
              if (paResponse.ok) {
                const paData = await paResponse.json();
                if (paData.imageUrl) {
                  coverUrl = paData.imageUrl;
                }
                if (paData.detailPageUrl) {
                  amazonHref = paData.detailPageUrl;
                }
              }
            } catch (paError) {
              console.warn('PA API failed:', paError);
            }
          }

          // Do not use non-PA images unless we have uploader rights; if provided by Firestore with rights, allow
          if (!coverUrl && b.coverUrl && b.coverRights === true) {
            coverUrl = b.coverUrl;
          }

          if (coverUrl) {
            const img = new Image();
            img.onload = () => {
              cover.src = coverUrl;
              cover.classList.remove('loading-img');
              // Wrap cover with Amazon link if available
              try {
                const link = document.getElementById('purchaseLink');
                const a = document.createElement('a');
                a.href = amazonHref || link?.href || '#';
                a.target = '_blank';
                a.setAttribute('aria-label', 'View on Amazon');
                const parent = cover.parentNode;
                a.appendChild(cover.cloneNode(true));
                parent.replaceChild(a, cover);
              } catch (_) {}
            };
            img.onerror = () => {
              const parent = cover.parentNode;
              const fallback = createTextCoverEl(b.title || 'Untitled', b.author || '');
              parent.replaceChild(fallback, cover);
              console.warn('Failed to load cover image:', coverUrl);
            };
            img.src = coverUrl;
          } else {
            const parent = cover.parentNode;
            const fallback = createTextCoverEl(b.title || 'Untitled', b.author || '');
            parent.replaceChild(fallback, cover);
          }
        }
        
        // Handle purchase links with vendor-aware labels
        const link = document.getElementById('purchaseLink');
        const link2 = document.getElementById('purchaseLink2');

        function getRef(){ try{ return sessionStorage.getItem('nf_ref') || ''; }catch(_){ return ''; } }
        function withAmazonTag(url){ try{ const u=new URL(url); u.searchParams.set('tag','noctuaforest-20'); const r=getRef(); if(r) u.searchParams.set('ref', r); return u.toString(); }catch(_){ return url; } }
        function amazonSearch(){ const q=encodeURIComponent(`${b.title||''} ${b.author||''}`); const r=getRef(); return `https://amazon.com/s?k=${q}&tag=noctuaforest-20${r?`&ref=${encodeURIComponent(r)}`:''}`; }

        // Create a text-based cover element when no image is available
        function createTextCoverEl(title, author){
          const el = document.createElement('div');
          el.className = 'relative rounded-lg shadow bg-[#4A5450] aspect-[2/3] flex items-center justify-center p-4';
          const inner = document.createElement('div');
          inner.className = 'text-center px-2';
          const t = document.createElement('div');
          t.className = 'text-base font-semibold text-white line-clamp-3';
          t.textContent = title || '';
          const a = document.createElement('div');
          a.className = 'mt-1 text-sm text-white/70 line-clamp-1';
          a.textContent = author ? `by ${author}` : '';
          inner.appendChild(t);
          inner.appendChild(a);
          el.appendChild(inner);
          return el;
        }
        // Bookshop links removed by product decision

        // Build purchase link candidates
        const candidates = [];
        const amazonHrefFinal = (typeof amazonHref !== 'undefined' && amazonHref) ? amazonHref : '';
        if (amazonHrefFinal) {
          candidates.push({ label: 'Buy on Amazon', href: withAmazonTag(amazonHrefFinal) });
        }
        // Search fallback
        candidates.push({ label: 'Search on Amazon', href: amazonSearch() });

        // Deduplicate by label then href
        const seen = new Set();
        const chosen = [];
        for (const c of candidates){ const key=c.label+"|"+c.href; if (seen.has(key)) continue; seen.add(key); chosen.push(c); }

        // Apply to UI
        if (link) {
          const primary = chosen[0];
          if (primary){
            link.href = primary.href;
            link.textContent = primary.label;
            if (document.documentElement.classList.contains('safari')) {
              link.addEventListener('touchend', (e) => { e.preventDefault(); window.open(primary.href, '_blank'); }, { passive: false });
            }
          } else {
            link.style.display = 'none';
          }
        }

        if (link2) {
          const secondary = chosen.find(c => !link || c.href !== link.href);
          if (secondary){
            link2.href = secondary.href;
            link2.textContent = secondary.label;
            link2.classList.remove('hidden');
          } else {
            link2.classList.add('hidden');
          }
        }
        
        // Update Book Schema Markup with comprehensive data for LLMs
        const bookSchema = document.getElementById('bookSchema');
        if (bookSchema) {
          const schema = {
            "@context": "https://schema.org",
            "@type": "Book",
            "name": b.title || "Untitled",
            "author": {
              "@type": "Person",
              "name": b.author || "Unknown"
            },
            "datePublished": b.publicationYear || "",
            "inLanguage": b.primaryLanguage || "en",
            "genre": b.categories || b.authorTags || "",
            "publisher": {
              "@type": "Organization", 
              "name": b.publisher || "Independent"
            },
            "isbn": b.isbn || "",
            "url": window.location.href,
            "image": b.coverUrl || "",
            "offers": {
              "@type": "Offer",
              "availability": "https://schema.org/InStock",
              "url": (document.getElementById('purchaseLink')?.href) || window.location.href,
              "seller": {
                "@type": "Organization",
                "name": "Amazon"
              }
            },
            "aggregateRating": {
              "@type": "AggregateRating",
              "ratingValue": "0",
              "reviewCount": "0",
              "description": "Community reviews focus on authentic reading experiences rather than numerical ratings"
            },
            "mainEntityOfPage": {
              "@type": "WebPage",
              "@id": window.location.href
            }
          };
          bookSchema.textContent = JSON.stringify(schema, null, 2);
        }

        // Store current book for list management
        currentBook = {
          id: id,
          title: b.title || 'Untitled',
          author: b.author || 'Unknown',
          coverUrl: b.coverUrl,
          primaryLanguage: b.primaryLanguage,
          genre: b.genre
        };

        // Load recommendations
        await loadRecommendations(id, b);

        // Display list save count (readers + curators)
        try {
          const { getBookSaveCount } = await import('./js/readingListService.js');
          const count = await getBookSaveCount(id);
          const actionMsg = document.getElementById('actionMsg');
          if (actionMsg) {
            actionMsg.textContent = count > 0 ? `Saved in ${count} list${count===1?'':'s'}.` : 'Be the first to save this to a list.';
            actionMsg.classList.remove('hidden');
            actionMsg.classList.add('text-white');
          }
        } catch (err) {
          // Silent fail; non-critical
        }

        // Display curator list count and member CTA
        try {
            const curatorListCount = await getActiveListsCount(id);
            const curatorAttribution = document.getElementById('curatorAttribution');
            const memberAttribution = document.getElementById('memberAttribution');
            
            if (curatorAttribution && curatorListCount > 0) {
                curatorAttribution.textContent = `Featured in ${curatorListCount} curator list${curatorListCount === 1 ? '' : 's'}.`;
                curatorAttribution.classList.remove('hidden');
            }

            // Show member CTA if not logged in or not a member
            const userDoc = auth.currentUser ? await getDoc(doc(db, 'users', auth.currentUser.uid)) : null;
            const data = userDoc?.exists() ? userDoc.data() : {};
            if (!auth.currentUser || data.membership !== 'active') {
                memberAttribution?.classList.remove('hidden');
            }
        } catch (err) {
            console.warn('Could not load curator list count', err);
        }
      }catch(err){
        console.error(err);
        document.getElementById('loading').textContent = 'Error loading book.';
      }
    }

    // Review handling - redirect to reviews page
    function showReviewForm() {
      window.location.href = 'reviews.html';
    }

    function showSignInPrompt() {
      window.location.href = 'account.html';
    }

    function formatDate(timestamp) {
      if (!timestamp) return '';
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      return new Intl.DateTimeFormat('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      }).format(date);
    }

    function renderBookCard(book) {
      const card = document.createElement('a');
      card.href = `book.html?id=${book.id}`;
      card.className = 'block bg-[#3A4440] rounded-lg overflow-hidden hover:opacity-90 transition-opacity focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-forest-accent';

      const cover = book.coverUrl || '';
      const hasCover = !!(cover && String(cover).trim());
      const imgTag = hasCover ? `
            <img 
              src="${cover}"
              alt="${book.title} cover"
              class="w-full h-full object-cover"
              loading="lazy"
              decoding="async"
              onerror="this.replaceWith((() => { const d=document.createElement('div'); d.className='absolute inset-0 flex items-center justify-center p-3'; d.innerHTML=\`<div class=\'text-center\'><div class=\'text-sm font-semibold text-white line-clamp-3\'>${book.title||'Untitled'}</div><div class=\'mt-1 text-xs text-white/70 line-clamp-1\'>${book.author||''}</div></div>\`; return d; })())"
            >
          ` : `
            <div class="absolute inset-0 flex items-center justify-center p-3">
              <div class="text-center">
                <div class="text-sm font-semibold text-white line-clamp-3">${book.title || 'Untitled'}</div>
                <div class="mt-1 text-xs text-white/70 line-clamp-1">${book.author || ''}</div>
              </div>
            </div>`;

      card.innerHTML = `
        <div class="aspect-[2/3] bg-[#4A5450] relative">
          ${imgTag}
        </div>
        <div class="p-4">
          <h3 class="font-medium text-white line-clamp-2">${book.title || 'Untitled'}</h3>
          <p class="text-sm text-white/60 mt-1">${book.author || ''}</p>
        </div>
      `;

      return card;
    }

    async function renderWordCloud(moodStats){
      const container = document.getElementById('wordCloud');
      if (!container) return;
      if (!moodStats || !moodStats.moods || moodStats.moods.length === 0){
        container.innerHTML = '<div class="text-white/60 text-sm">No mood data yet</div>';
        return;
      }
      const max = Math.max(...moodStats.moods.map(m=>m.count||m.percentage||1));
      container.innerHTML = '';
      container.style.display = 'flex';
      container.style.flexWrap = 'wrap';
      container.style.gap = '12px';
      moodStats.moods.forEach(({ mood, count=0, percentage=0 }) => {
        const weight = count || percentage;
        const size = 14 + Math.round((weight / max) * 20); // 14px - 34px
        const span = document.createElement('span');
        span.textContent = mood.charAt(0).toUpperCase() + mood.slice(1);
        span.style.fontSize = size + 'px';
        span.className = 'select-none';
        container.appendChild(span);
      });
    }

    function renderWarningsSpoiler(warningStats){
      const btn = document.getElementById('toggleWarnings');
      const list = document.getElementById('warningsList');
      if (!btn || !list) return;

      const MAX_WARNINGS_DISPLAY = 5;
      let open = false;
      function setClosed(){
        list.classList.add('hidden');
        btn.textContent = 'Show warnings';
      }
      function setOpen(){
        list.classList.remove('hidden');
        btn.textContent = 'Hide warnings';
      }
      btn.onclick = () => { open = !open; open ? setOpen() : setClosed(); };

      if (!warningStats || !warningStats.warnings || warningStats.warnings.length === 0){
        list.innerHTML = '<div class="text-white/60 text-sm">No content warnings reported</div>';
        setClosed();
        return;
      }

      const topWarnings = warningStats.warnings.slice(0, MAX_WARNINGS_DISPLAY);
      list.innerHTML = topWarnings.map(({ warning, count }, idx) => {
        const label = (warning || '').replaceAll('_',' ');
        const id = `warn_${idx}`;
        return `
        <button id="${id}" type="button" class="mr-2 mb-2 inline-flex items-center px-2 py-1 rounded-full bg-red-500/20 text-red-300 text-xs hover:bg-red-500/30 transition"
                aria-label="Reveal content warning" data-warning="${label}" data-count="${count}">
          <span class="select-none" data-hidden>⚠︎ Spoiler</span>
        </button>`;
      }).join('');

      // Wire per-warning reveal
      topWarnings.forEach((w, idx) => {
        const el = document.getElementById(`warn_${idx}`);
        if (!el) return;
        el.addEventListener('click', () => {
          const label = (w.warning || '').replaceAll('_',' ');
          const count = w.count || 0;
          el.innerHTML = `<span>${label} (${count})</span>`;
          el.classList.remove('bg-red-500/20','text-red-300');
          el.classList.add('bg-red-500/25','text-red-200');
          el.setAttribute('aria-label', `Content warning: ${label}`);
        }, { once: true });
      });

      setClosed();
    }

    function formatBasic(text){
      // bold **text**, italics *text*
      return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1<\/strong>')
        .replace(/\*(.*?)\*/g, '<em>$1<\/em>');
    }

    function createReadMore(text, maxChars = 240){
      if (!text || text.length <= maxChars) return { html: formatBasic(text), truncated: false };
      const short = text.slice(0, maxChars).trim();
      const html = `${formatBasic(short)}<span class="text-white/60">… </span><button class="underline text-forest-accent" data-readmore>Read more</button>`;
      return { html, truncated: true };
    }

    async function renderReview(review) {
      const div = document.createElement('div');
      div.className = 'bg-[#3A4440] rounded-lg p-6';

      const { html, truncated } = createReadMore(review.text || '');

      div.innerHTML = `
        <div class="space-y-4">
          <div class="flex items-start justify-between">
            <div class="flex items-center gap-3">
              ${review.authorAvatarUrl ? 
                `<img src="${review.authorAvatarUrl}" alt="Avatar" class="w-10 h-10 rounded-full object-cover">` :
                `<div class="w-10 h-10 rounded-full bg-[#5A6560] flex items-center justify-center">
                  <svg class="w-5 h-5 text-white/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                  </svg>
                </div>`
              }
              <div>
                <div class="font-medium text-white">${review.authorForestName || 'Anonymous Night Owl'}</div>
                <div class="text-sm text-white/60">${formatDate(review.createdAt)}</div>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <button 
                class="report-button"
                data-review-id="${review.id}"
                title="Report review"
                onclick="reportReview('${review.id}')">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <span>Report</span>
              </button>
            </div>
          </div>

          <div class="text-white/80 review-text">${html}</div>

          ${review.moods && review.moods.length > 0 ? `
            <div class="flex flex-wrap gap-2 mt-4">
              ${review.moods.map(mood => `
                <span class="px-2 py-1 rounded-full text-xs text-white ${getMoodColor(mood)}">
                  ${formatMoodName(mood)}
                </span>
              `).join('')}
            </div>
          ` : ''}

          ${review.contentWarnings && review.contentWarnings.length > 0 ? `
            <div class="flex flex-wrap gap-2 mt-2">
              ${review.contentWarnings.map(warning => `
                <span class="px-2 py-1 rounded-full text-xs bg-red-500/20 text-red-400">
                  ${formatWarningName(warning)}
                </span>
              `).join('')}
            </div>
          ` : ''}
        </div>
      `;

      // Read more toggle
      if (truncated){
        const btn = div.querySelector('[data-readmore]');
        if (btn){
          btn.addEventListener('click', () => {
            const full = formatBasic(review.text || '');
            const textEl = div.querySelector('.review-text');
            textEl.innerHTML = full;
          });
        }
      }

      return div;
    }

    async function updateReviewStats(bookId) {
      try {
        // Word cloud from mood stats
        const moodStats = await getBookMoods(bookId);
        await renderWordCloud(moodStats);

        // Summarized warnings with spoiler toggle
        const warningStats = await getContentWarnings(bookId);
        renderWarningsSpoiler(warningStats);

        // Copy format natural language summary
        const fmt = await getCopyFormatStats(bookId);
        const fmtEl = document.getElementById('copyFormatSummary');
        if (fmtEl) {
          if (fmt.total > 0) {
            const digital = fmt.ebook + fmt.audiobook;
            const pDigital = Math.round((digital / fmt.total) * 100);
            const pPrint = Math.round((fmt.print / fmt.total) * 100);
            if (pDigital >= pPrint) {
              fmtEl.textContent = `${pDigital}% of readers own a digital copy`;
            } else {
              fmtEl.textContent = `${pPrint}% of readers own a printed copy`;
            }
          } else {
            fmtEl.textContent = '';
          }
        }
      } catch (err) {
        console.error('Error updating summary stats:', err);
      }
    }

    async function setupReviews(bookId) {
      const reviewList = document.getElementById('reviewList');
      const reviewsEmpty = document.getElementById('reviewsEmpty');
      const reviewSort = document.getElementById('reviewSort');
      const policyModal = document.getElementById('policyModal');
      const closePolicyModal = document.getElementById('closePolicyModal');

      const { migrateAllComments, isCommentsEmpty } = await import('./js/reviewsMigration.js');

      // Migration check (unchanged)
      try { const hasComments = !(await isCommentsEmpty()); if (hasComments){ const stats = await migrateAllComments(); } } catch(_) {}

      onAuthStateChanged(auth, (user) => { 
        // User authentication state changed - just update UI, don't auto-redirect
        console.log('Auth state changed:', user ? 'signed in' : 'signed out');
      });

      // Build base query and sorting
      let orderField = 'createdAt';
      let orderDir = 'desc';
      function applySort(){
        // Only newest sorting available
        orderField = 'createdAt';
        orderDir = 'desc';
        subscribe();
      }
      reviewSort?.addEventListener('change', applySort);

      let unsubscribe = () => {};
      function subscribe(){
        unsubscribe();
        
        // Always use non-ordered query to avoid composite index requirement; sort client-side
        const qy = query(
          collection(db, 'reviews'),
          where('bookId', '==', bookId),
          limit(50)
        );
        
        unsubscribe = onSnapshot(qy, async (snapshot) => {
          reviewList.innerHTML = '';
          if (snapshot.empty) {
            reviewsEmpty.classList.remove('hidden');
            const bottomCta = document.getElementById('bottomReviewCta');
            bottomCta?.classList.remove('hidden');
            return;
          }
          
          let reviews = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          // Sort client-side by creation date (newest first)
          reviews.sort((a, b) => {
            const aTime = a.createdAt?.toDate?.() || new Date(a.createdAt) || new Date(0);
            const bTime = b.createdAt?.toDate?.() || new Date(b.createdAt) || new Date(0);
            return bTime - aTime;
          });
          
          reviewsEmpty.classList.add('hidden');
          const bottomCta = document.getElementById('bottomReviewCta');
          bottomCta?.classList.add('hidden');
          
          for (const r of reviews){ reviewList.appendChild(await renderReview(r)); }
        }, (error) => {
          console.error('Error loading reviews:', error);
          reviewList.innerHTML = '<p class="text-white/60 text-center py-4">Unable to load reviews. Please try again later.</p>';
        });
      }

      // Initial subscription
      applySort();


      // Initial summary load
      await updateReviewStats(bookId);

      // Cleanup
      window.addEventListener('unload', () => unsubscribe());
    }

    // Report review function
    window.reportReview = async (reviewId) => {
      if (!auth.currentUser) {
        showSignInPrompt();
        return;
      }

      // Create report modal
      const reportModal = document.createElement('div');
      reportModal.className = 'fixed inset-0 bg-black/60 flex items-center justify-center z-50';
      reportModal.innerHTML = `
        <div class="bg-white rounded-xl w-full max-w-md mx-4 p-6">
          <h3 class="text-xl font-bold mb-4 text-[#4A5450]">Report Review</h3>
          <form id="reportForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-[#4A5450] mb-2">Reason for reporting</label>
              <select class="w-full px-4 py-2 rounded-lg bg-[#F1F5F9] border border-[#E2E8F0] text-[#4A5450]" required>
                <option value="">Select a reason...</option>
                <option value="ai_generated">Appears to be AI-generated</option>
                <option value="spam">Spam or promotional content</option>
                <option value="inappropriate">Inappropriate content</option>
                <option value="harassment">Harassment or personal attack</option>
                <option value="duplicate">Duplicate review</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-[#4A5450] mb-2">Additional details (optional)</label>
              <textarea class="w-full px-4 py-2 rounded-lg bg-[#F1F5F9] border border-[#E2E8F0] text-[#4A5450]" rows="3" placeholder="Please provide any additional context that will help us understand your report..."></textarea>
            </div>
            <div class="flex justify-end gap-3">
              <button type="button" class="px-4 py-2 bg-[#F1F5F9] text-[#4A5450] rounded-md hover:bg-[#E2E8F0]" onclick="this.parentElement.parentElement.parentElement.parentElement.remove()">
                Cancel
              </button>
              <button type="submit" class="px-4 py-2 bg-[#4A5450] text-white rounded-md hover:bg-[#3A4440]">
                Submit Report
              </button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(reportModal);

      // Handle report submission
      const form = reportModal.querySelector('#reportForm');
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const reason = form.querySelector('select').value;
        const details = form.querySelector('textarea').value;

        try {
          await reportReview(reviewId, reason, auth.currentUser.uid, details);
          reportModal.remove();

          // Show confirmation
          const confirmModal = document.createElement('div');
          confirmModal.className = 'fixed inset-0 bg-black/60 flex items-center justify-center z-50';
          confirmModal.innerHTML = `
            <div class="bg-white rounded-xl w-full max-w-md mx-4 p-6">
              <h3 class="text-xl font-bold mb-4 text-[#4A5450]">Report Submitted</h3>
              <p class="text-[#4A5450] mb-6">Thank you for helping maintain the quality of our community. We'll review this report promptly.</p>
              <button class="w-full px-4 py-2 bg-[#4A5450] text-white rounded-md hover:bg-[#3A4440]" onclick="this.parentElement.parentElement.remove()">
                Close
              </button>
            </div>
          `;
          document.body.appendChild(confirmModal);
        } catch (err) {
          console.error('Error submitting report:', err);
          alert('Unable to submit report. Please try again.');
        }
      });
    };

    onAuthStateChanged(auth, ()=>{}); // establish auth; no redirect required
    const bookId = getParam('id');
    if (!bookId) {
      // Guard against book.html?id=undefined or missing id
      console.error('No book ID provided, redirecting to Forest');
      window.location.replace('forest.html');
    } else {
      loadBook();
      setupReviews(bookId);
    }
  </script>
  <div id="navOverlay" class="nav-overlay"></div>
  <script src="assets/nav.js"></script>
</body>
</html>


